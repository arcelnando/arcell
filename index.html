<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğ‚ğ„ğ‹ğ™ ğ€ğ‹ğğ”ğŒ ğ‚ğ‡ğ€ğ“</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* ... (SEMUA GAYA CSS ANDA SEBELUMNYA) ... */
/* Reset & Global */
html, body {
  margin:0; padding:0;
  font-family:'Poppins',sans-serif;
  height:100%; width:100%;
  overflow:hidden;
  background:linear-gradient(135deg,#ffd6e8,#ffb3d1,#ff99c7);
  display:flex; justify-content:center; align-items:center;
  color:#333;
  line-height:1.6;
}

/* Particle Background */
#particleContainer{
  position:fixed; top:0; left:0;
  width:100%; height:100%;
  pointer-events:none;
  overflow:hidden; z-index:0;
}
.particle{
  position:absolute; width:8px; height:8px;
  background:rgba(255,182,193,0.35);
  transform:rotate(45deg); border-radius:50%;
  animation-name:float; animation-timing-function:linear;
  animation-iteration-count:infinite;
  opacity:0;
  animation-fill-mode:forwards;
}
@keyframes float{
  0%{transform:translate(0,0) rotate(45deg) scale(0.5);opacity:0;}
  20%{opacity:0.6;}
  80%{opacity:0.4;}
  100%{transform:translate(var(--x), var(--y)) rotate(45deg) scale(1.2);opacity:0;}
}

/* Navbar */
.navbar{
  position:fixed; top:0; left:0;
  width:100%;
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(10px);
  display:flex; justify-content:center; align-items:center;
  padding:12px 0; z-index:1000;
  box-shadow:0 2px 15px rgba(0,0,0,0.1);
  display:none;
}
.navbar ul{
  list-style:none; display:flex; gap:20px; margin:0; padding:0; align-items:center;
}
.navbar button{
  background:none; border:none; color:white; font-size:1em;
  cursor:pointer; letter-spacing:1px; position:relative; transition:color 0.3s;
  font-weight:600; padding: 5px 10px;
}
.navbar button::after{
  content:''; position:absolute; left:0; bottom:-5px; width:0%; height:2px;
  background:#ffc0de; transition:width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.navbar button:hover{ color:#ffe3f1; }
.navbar button:hover::after{ width:100%; }
.menu-toggle{ display:none; flex-direction:column; cursor:pointer; position:absolute; right:20px; top:14px; }
.menu-toggle span{ width:25px; height:3px; background:white; margin:4px 0; border-radius:2px; transition:0.3s; }
@media(max-width:700px){
  .navbar ul{ flex-direction:column; background:rgba(255,255,255,0.15);
    position:fixed; top:55px; right:-100%; width:60%; height:100vh;
    text-align:center; transition:right 0.4s ease; padding-top:60px;
    box-shadow:-5px 0 15px rgba(0,0,0,0.1); gap: 25px;
  }
  .navbar ul.active{ right:0; }
  .menu-toggle{ display:flex; }
  .menu-toggle.active span:nth-child(1){ transform:rotate(-45deg) translate(-5px, 6px); }
  .menu-toggle.active span:nth-child(2){ opacity:0; }
  .menu-toggle.active span:nth-child(3){ transform:rotate(45deg) translate(-5px, -6px); }
}

/* Page */
.page{
  width:100%; height:100%;
  display:none; justify-content:center; align-items:center; flex-direction:column;
  opacity:0; transition:opacity 0.8s ease-in-out;
  position:absolute; top:0; left:0;
}
.active-page{ display:flex; opacity:1; }

/* Album */
.album-wrapper{ position:relative; text-align:center; width:90%; max-width:700px; z-index:2; opacity:0; transition:opacity 1.2s ease; }
.album-wrapper.show{ opacity:1; }
.folder-album-wrapper{ opacity:1; } 
.romantic-text{ font-size:2em; margin-bottom:20px; text-shadow:0 0 20px rgba(255,255,255,0.6); color:#fff; font-weight:700; }
.album-container{
  position:relative; width:100%; height:650px;
  border-radius:25px; overflow:hidden;
  border:2px solid rgba(255,255,255,0.3);
  background:rgba(255,255,255,0.07);
  backdrop-filter:blur(12px);
  box-shadow:0 15px 35px rgba(0,0,0,0.3);
  touch-action:pan-x;
  display:flex; justify-content:center; align-items:center; 
}
/* Tambahkan lapisan untuk Double Tap Like Feedback */
.album-container::after {
    content: attr(data-like-feedback);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 5em;
    color: #ff4d6d;
    opacity: 0;
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none;
    z-index: 5;
    text-shadow: 0 0 10px rgba(0,0,0,0.5);
}
.album-container.double-tap-liked::after {
    content: 'â¤ï¸';
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.2);
    animation: fadeOutPop 0.8s ease-out forwards;
}
@keyframes fadeOutPop {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(0.8); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
}


.photo{
  width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0;
  opacity:0; transition:opacity 1.3s ease-in-out, transform 1.3s ease-in-out, box-shadow 1.3s ease-in-out;
  border-radius:20px; box-shadow:0 0 0px rgba(255,192,222,0);
}
.photo.active{ opacity:1; z-index:2; transform:scale(1.03); box-shadow:0 0 40px rgba(255,192,222,0.6); }
.nav-btn{
  position:absolute; top:50%; transform:translateY(-50%);
  font-size:2em; color:white; background:rgba(255,255,255,0.2);
  border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; z-index:3; transition:background 0.3s, transform 0.3s;
  display:flex; justify-content:center; align-items:center;
}
.nav-btn:hover{ background:rgba(255,255,255,0.4); transform:translateY(-50%) scale(1.1); }
.prev-btn{ left:10px; } .next-btn{ right:10px; }

/* Photo Indicator (Dots) */
.photo-indicator{
  display:none; 
  justify-content:center; margin-top:15px; gap:8px; z-index:4;
}
.dot{
  width:10px; height:10px; border-radius:50%; background:rgba(255,255,255,0.4);
  cursor:pointer; transition:all 0.3s; border:1px solid rgba(255,255,255,0.2);
}
.dot.active{
  background:#ffc0de; width:12px; height:12px;
  transform:scale(1.1); box-shadow:0 0 10px rgba(255,192,222,0.8);
}
.dot:hover{
  background:#ffb3d1; transform:scale(1.2);
}


/* Menu bawah foto - PERBAIKAN TOMBOL */
.photo-menu{
  position:relative;
  margin-top:20px;
  display:flex; gap:20px; justify-content:center; background:rgba(255,255,255,0.15);
  padding:10px 20px; border-radius:25px; backdrop-filter:blur(10px); z-index:4;
  box-shadow:0 5px 15px rgba(0,0,0,0.1);
}
.photo-menu button{
  background:none; border:none; color:white; font-size:1em; cursor:pointer; 
  position:relative; font-weight:600;
  display:flex; align-items:center; gap:5px;
  transition: color 0.3s, transform 0.3s;
}
.photo-menu button .icon {
  font-size: 1.2em;
  line-height: 1;
  vertical-align: middle;
}
.photo-menu button:hover{ color:#ffb3d1; transform:scale(1.05); }
.photo-menu button:hover .icon {
  transform: scale(1.1);
}

/* Gaya Khusus untuk Tombol Like (dengan hati yang berdetak) */
.like-btn .icon {
    transition: color 0.3s, transform 0.3s;
}
/* Menggunakan kelas 'liked' pada tombol untuk feedback visual */
.like-btn.liked .icon {
    color: #ff528a; /* Warna merah saat disukai */
    animation: pulse 0.5s infinite alternate; /* Animasi detak */
}
.like-btn:not(.liked) .icon {
    color: white; /* Warna putih saat belum disukai */
    animation: none;
}
@keyframes pulse {
    0% { transform: scale(1.0); }
    100% { transform: scale(1.2); }
}


/* Info Box */
.info-box{ background: rgba(255,255,255,0.08); backdrop-filter: blur(10px);
  padding:30px; border-radius:20px; color:#fff; text-align:center;
  box-shadow:0 15px 40px rgba(0,0,0,0.3); max-width:500px;
  animation: fadeInScale 0.8s forwards ease-out;
}
.info-box h2{ color:#ffe3f1; font-weight:700; margin-bottom:15px; }
.info-box p{ font-size:1.1em; margin-bottom:10px; }
.info-box a{ color:#ffc0de; text-decoration:none; font-weight:bold; }
.info-box a:hover{ text-decoration:underline; }

/* Login */
#loginPage{
  width:100%; height:100%; display:flex; justify-content:center; align-items:center;
  flex-direction:column; z-index:1000;
}
#loginTitle{
  color:#fff; font-size:2.5em; margin-bottom:25px; text-shadow:0 0 25px rgba(255,255,255,0.8); text-align:center;
  font-weight:700; animation: bounceIn 1s ease-out;
}
#loginBox{
  background:rgba(255,255,255,0.1); backdrop-filter:blur(12px);
  padding:40px 30px; border-radius:25px; box-shadow:0 15px 40px rgba(0,0,0,0.3);
  display:flex; flex-direction:column; gap:20px; width:300px; max-width:90%;
  animation: fadeInScale 0.8s forwards ease-out 0.2s; opacity:0;
}
#loginBox input{
  padding:14px 18px; border-radius:18px; border:1px solid rgba(255,255,255,0.3); outline:none;
  font-size:1em; background:rgba(255,255,255,0.2); color:white;
  transition:border-color 0.3s, background 0.3s;
}
#loginBox input::placeholder{ color:rgba(255,255,255,0.7); }
#loginBox input:focus{ border-color:#ffb3d1; background:rgba(255,255,255,0.3); }
#loginBox button{
  padding:14px; border:none; border-radius:18px;
  background:#ff99c7; color:white; font-weight:bold; cursor:pointer; transition:0.3s;
  font-size:1.1em; box-shadow:0 5px 15px rgba(0,0,0,0.2);
}
#loginBox button:hover{ background:#ffb3d1; transform:translateY(-2px); box-shadow:0 7px 20px rgba(0,0,0,0.3); }
.show-pass{
  position:relative; color:#fff; font-size:0.9em; cursor:pointer; text-align:right; margin-top:-10px;
  transition:color 0.3s;
}
.show-pass:hover{ color:#ffc0de; }
#loginError{color:#ffb3b3; font-size:0.9em; text-align:center; display:none; margin-top:-10px;}

/* Welcome Message */
#welcomeMessage{
  background:rgba(255,255,255,0.1); backdrop-filter:blur(12px);
  padding:30px; border-radius:20px; color:#fff; text-align:center;
  box-shadow:0 15px 40px rgba(0,0,0,0.3); max-width:400px;
  animation: fadeInScale 0.8s forwards ease-out; opacity:0;
  display:none; flex-direction:column; gap:20px;
}
#welcomeMessage h2{ font-size:2em; color:#ffe3f1; margin-bottom:10px; }
#welcomeMessage p{ font-size:1.1em; }
#welcomeMessage button{
  padding:12px 25px; border-radius:15px; border:none;
  background:#ff99c7; color:white; font-weight:bold; cursor:pointer; transition:0.3s;
  font-size:1em; box-shadow:0 5px 15px rgba(0,0,0,0.2);
}
#welcomeMessage button:hover{ background:#ffb3d1; transform:translateY(-2px); box-shadow:0 7px 20px rgba(0,0,0,0.3); }

/* Tombol Kembali */
.back-btn{
  position:fixed; top:20px; left:20px; z-index:100;
  padding:10px 15px; border-radius:10px; border:none;
  background:rgba(255,255,255,0.2); backdrop-filter:blur(5px);
  color:white; font-weight:bold; cursor:pointer; transition:0.3s, transform 0.3s;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
  display:flex; align-items:center; gap:5px;
}
.back-btn:hover{ background:rgba(255,255,255,0.4); transform:translateY(-2px); }

/* Tombol Folder */
.folder-btn{
  padding:18px 25px; border:none; border-radius:20px;
  background:#ff99c7; color:white; font-weight:bold; cursor:pointer; transition:0.3s;
  font-size:1.2em; letter-spacing:1px;
  box-shadow:0 5px 20px rgba(0,0,0,0.2);
  display:flex; justify-content:center; align-items:center;
  gap:10px;
  animation: fadeInScale 0.6s forwards ease-out; opacity:0;
}
.folder-btn:hover{ background:#ffb3d1 !important; transform:scale(1.03) translateY(-3px); box-shadow:0 8px 25px rgba(0,0,0,0.3); }
#folder1Btn{ animation-delay:0.2s; }
#folder2Btn{ animation-delay:0.4s; }

/* Loading Spinner */
.loading-spinner {
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid #ffc0de;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1; 
}
@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Fallback Image Style */
.fallback-img {
    background-color: #f0f0f0;
    color: #888;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.2em;
    text-align: center;
    border-radius: 20px;
    border: 2px dashed #ccc;
}


/* Animations */
@keyframes fadeInScale {
  0% { opacity: 0; transform: scale(0.9); }
  100% { opacity: 1; transform: scale(1); }
}
@keyframes bounceIn {
  0% { opacity: 0; transform: scale(0.3); }
  50% { opacity: 1; transform: scale(1.05); }
  70% { transform: scale(0.9); }
  100% { transform: scale(1); }
}

/* Responsive */
@media(max-width:600px){
  .romantic-text{ font-size:1.8em; margin-bottom:15px; }
  .album-container{ height:400px; border-radius:15px; }
  .photo{ border-radius:10px; }
  .nav-btn{ width:40px; height:40px; font-size:1.5em; }
  .prev-btn{ left:5px; } .next-btn{ right:5px; }
  .back-btn{ top:10px; left:10px; padding:8px 12px; font-size:0.9em; }
  #loginTitle{ font-size:2em; margin-bottom:20px; }
  #loginBox{ padding:30px 20px; }
  .folder-btn{ font-size:1em; padding:12px 20px; }
  .photo-menu{ margin-top:15px; padding:8px 15px; }
  .photo-menu button{ font-size:0.9em; }
  #welcomeMessage h2{ font-size:1.8em; }
  #welcomeMessage p{ font-size:1em; }
  
  /* PERBAIKAN: Chat Page lebih kecil di mobile */
  #chatPage .info-box { height: 80vh !important; }
}

/* PENAMBAHAN 4: CHAT STYLING */
#chatPage .info-box, #zazaAIPage .info-box {
    max-width: 600px;
    height: 80vh; 
    display: flex;
    flex-direction: column;
    padding: 0;
}
#chatHeader, #zazaAIHeader {
    padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.1);
    backdrop-filter: blur(8px);
}
#chatMessages, #zazaAIMessages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
    background: rgba(255,255,255,0.05);
    /* DITAMBAH: Tata letak Flexbox untuk pesan */
    display: flex; 
    flex-direction: column;
}
#chatMessages::-webkit-scrollbar, #zazaAIMessages::-webkit-scrollbar {
    width: 6px;
}
#chatMessages::-webkit-scrollbar-thumb, #zazaAIMessages::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

/* DITAMBAH: Gaya Gelembung Chat Modern (WhatsApp Style TRANSPARAN) */
.chat-bubble {
    transition: all 0.3s ease;
    position: relative;
    max-width: 85%; 
    word-wrap: break-word;
    /*box-shadow: 0 2px 5px rgba(0,0,0,0.2);*/ /* Hapus shadow */
    font-size: 0.95em;
    line-height: 1.4;
    margin-bottom: 8px; 
    padding: 0; 
    display: flex; 
    align-items: flex-end; 
    /* PENTING: Perubahan untuk WhatsApp-style bubble */
    margin-left: 0;
    margin-right: 0;
}
/* Gelembung pesan dari saya */
.chat-bubble.is-me {
    align-self: flex-end; /* Dorong ke kanan */
    justify-content: flex-end;
}
/* Gelembung pesan dari lawan */
.chat-bubble.is-opponent {
    align-self: flex-start; /* Dorong ke kiri */
    justify-content: flex-start;
}
/* Inner Bubble (untuk konten dan waktu) */
.chat-bubble-inner {
    padding: 10px 15px;
    border-radius: 15px;
    position: relative;
    max-width: 100%;
    /* PENAMBAHAN: Gaya Transparan/Blurnya */
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(5px);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
/* Gaya untuk inner bubble saya */
.chat-bubble.is-me .chat-bubble-inner {
    color: white;
    background: #ff99c7; 
    border-bottom-right-radius: 5px; 
}
/* Gaya untuk inner bubble lawan */
.chat-bubble.is-opponent .chat-bubble-inner {
    color: #333;
    background: rgba(255,255,255,0.85); 
    border-bottom-left-radius: 5px; 
}

.message-status {
    font-size: 1em !important; 
    margin-left: 3px; 
    vertical-align: middle;
}

/* FIX: Gaya untuk status pesan yang belum terbaca (sent) */
.message-status[data-status="sent"] {
    color: rgba(255,255,255,0.8); /* Putih/abu-abu untuk sent/delivered */
}
/* FIX: Gaya untuk status pesan yang sudah terbaca (read) */
.message-status[data-status="read"] {
    color: #00e676; /* Hijau untuk read */
}


/* --- Penambahan untuk Logout & Status --- */

/* Navbar - Tambahan untuk tombol Logout */
.navbar button#logoutBtn{
  background:#ff6f91; color:white; border-radius:15px; padding:8px 15px;
  box-shadow:0 3px 10px rgba(255,111,145,0.5);
  transition: transform 0.3s;
}
.navbar button#logoutBtn:hover{
  background:#ff8da8; transform:scale(1.05); color:white;
}
.navbar button#logoutBtn::after{
  display:none;
}
/* Chat Delete Button */
.delete-chat-btn {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff6f91;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s;
    line-height: 20px;
    text-align: center;
    z-index: 5;
}
.chat-bubble:hover .delete-chat-btn {
    opacity: 1;
}

/* Status Page Styling */
#statusPage .info-box {
    max-width: 500px;
    height: auto;
    min-height: 400px;
    padding: 30px;
}
#statusList {
    margin-top: 20px;
    width: 100%;
    max-height: 400px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 10px;
}
.status-item {
    padding: 15px;
    border-radius: 15px;
    background: rgba(255,255,255,0.1);
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: background 0.3s, border-left 0.3s;
    position: relative;
    border-left: 5px solid #ff99c7; /* Belum dilihat */
}
.status-item.viewed {
    border-left: 5px solid rgba(255,255,255,0.3); /* Sudah dilihat */
    background: rgba(255,255,255,0.05);
}
.status-item:hover {
    background: rgba(255,255,255,0.2);
}
.status-meta {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 0.85em; color: rgba(255,255,255,0.7); margin-top: 5px;
}
.status-meta .viewed-icon {
    display: flex; align-items: center; gap: 5px; color: #7aff7a; font-weight: 600;
}
/* Status Viewer */
#statusViewer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 2000;
    display: none; justify-content: center; align-items: center;
    flex-direction: column;
}
#viewerContent {
    background: #111; padding: 20px; border-radius: 15px; max-width: 90%; width: 400px;
    color: white; animation: fadeInScale 0.5s;
}
#statusReplyInput {
    padding: 10px; border-radius: 10px; border: none; width: 80%; margin-right: 10px;
    background: rgba(255,255,255,0.9); color: #333;
}
#statusLikeBtn, #statusReplyBtn, #deleteStatusBtn {
    padding: 10px 15px; border-radius: 10px; border: none; background: #ff99c7; color: white; margin-top: 10px; cursor: pointer; transition: 0.3s;
}
#statusLikeBtn:hover, #statusReplyBtn:hover { background: #ffb3d1; }
#deleteStatusBtn { background: #ff6f91; }
#deleteStatusBtn:hover { background: #ff8da8; }

/* Styling Media Chat */
.media-message {
    max-width: 200px; 
    max-height: 200px;
    border-radius: 10px;
    object-fit: contain;
    margin-top: 5px;
    display: block;
}

/* Styling Media Status */
#viewerMedia {
    max-width: 100%;
    max-height: 300px;
    object-fit: contain;
    border-radius: 10px;
    margin-bottom: 15px;
}

/* AI Chat Styling (tambahan) */
.ai-bubble-user {
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 15px;
    color: white;
    word-wrap: break-word;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-size: 0.95em;
    line-height: 1.4;
    align-self: flex-end;
    background: #99c7ff; /* Warna User AI */
    border-bottom-right-radius: 0;
    margin-bottom: 10px;
}
.ai-bubble-zaza {
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 15px;
    color: #333;
    word-wrap: break-word;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-size: 0.95em;
    line-height: 1.4;
    align-self: flex-start;
    background: rgba(255,255,255,0.85);
    border-bottom-left-radius: 0;
    margin-bottom: 10px;
}
.zaza-ai-footer{
    padding: 15px; border-top: 1px solid rgba(255,255,255,0.2); display: flex; gap: 10px; align-items: center;
}

/* Styling Profile Page */
#profilePage .info-box {
    max-width: 400px;
    height: auto;
    min-height: 400px;
    padding: 30px;
}

/* Tambahan untuk Avatar kustom */
.custom-avatar {
    width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
    margin: 0 auto 15px; border: 3px solid #ffe3f1;
    display: flex; justify-content: center; align-items: center;
    font-weight: 700; font-size: 2em; color: white; background: #ff99c7;
    cursor: pointer; /* Agar terasa dapat diklik */
    position: relative;
}
.custom-avatar::after {
    content: '\270E'; /* Icon pensil */
    position: absolute; bottom: 0; right: 0;
    background: #4CAF50; color: white; border-radius: 50%;
    padding: 4px; font-size: 0.6em; line-height: 1;
}

/* Modal Edit Profile */
#editProfileModal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); z-index: 2001;
    display: none; justify-content: center; align-items: center;
}
#editProfileContent {
    background: #222; padding: 30px; border-radius: 15px; max-width: 90%; width: 350px;
    color: white; animation: fadeInScale 0.5s;
    display: flex; flex-direction: column; gap: 15px;
}
#editProfileContent h3 { color: #ffc0de; margin-top: 0; }
#editProfileContent input, #editProfileContent textarea {
    padding: 10px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2);
    color: white; outline: none;
}
#editProfileContent button {
    padding: 10px 15px; border-radius: 10px; border: none; background: #ff99c7; color: white; 
    font-weight: bold; cursor: pointer; transition: 0.3s;
}
#editProfileContent button:hover { background: #ffb3d1; }


/* Modal View Profile */
#viewProfileModal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); z-index: 2001;
    display: none; justify-content: center; align-items: center;
}
#viewProfileContent {
    background: #222; padding: 30px; border-radius: 15px; max-width: 90%; width: 350px;
    color: white; animation: fadeInScale 0.5s;
    display: flex; flex-direction: column; gap: 15px;
    text-align: center;
}
#viewProfileContent h3 { color: #ffc0de; margin-top: 10px; }


/* PENAMBAHAN: Select Chat Page */
#selectChatPage .info-box {
    max-width: 400px;
    height: auto;
    padding: 30px;
}
.chat-contact-item {
    background: rgba(255,255,255,0.15);
    padding: 15px;
    border-radius: 15px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
    transition: background 0.3s;
}
.chat-contact-item:hover {
    background: rgba(255,255,255,0.3);
}
.contact-avatar {
    width: 50px; height: 50px; border-radius: 50%; background: #ff99c7; 
    display: flex; justify-content: center; align-items: center;
    font-weight: 700; font-size: 1.5em; color: white;
}

/* Avatar di dalam chat bubble harus bulat */
.chat-bubble .contact-avatar {
    border-radius: 50%; /* Pastikan avatar di dalam bubble bulat */
}
</style>
</head>
<body>

<div id="particleContainer"></div>

<nav class="navbar">
  <div class="menu-toggle" id="menuToggle"><span></span><span></span><span></span></div>
  <ul id="navMenu">
    <li><button id="homeBtn"><span class="material-icons">home</span> Home</button></li> 
    <li><button id="profileNavBtn"><span class="material-icons">person</span> Profil</button></li> 
    <li><button id="zazaAIBtn"><span class="material-icons">auto_awesome</span> Tanya Zaza AI</button></li> 
    <li><button id="chatNavBtn"><span class="material-icons">message</span> Chat</button></li> 
    <li><button id="statusNavBtn"><span class="material-icons">auto_stories</span> Status</button></li> 
    <li><button id="aboutBtn"><span class="material-icons">info</span> About</button></li> 
    <li><button id="contactBtn"><span class="material-icons">email</span> Contact</button></li> 
    <li><button id="logoutBtn"><span class="material-icons">logout</span> Logout</button></li>
  </ul>
</nav>

<div class="page active-page" id="loginPage">
  <div id="loginTitle">ğ—Ÿğ—¢ğ—šğ—œğ—¡ ğ—¨ğ—¡ğ—§ğ—¨ğ— ğ— ğ—˜ğ—Ÿğ—œğ—›ğ—”ğ—§ ğ—”ğ—Ÿğ—•ğ—¨ğ— </div>
  <div id="loginBox">
    <input type="text" id="username" placeholder="Username"> 
    <input type="password" id="password" placeholder="Password"> 
    <div class="show-pass" id="togglePass">Show Password</div>
    <button id="loginBtn">Login</button>
    <div id="loginError">Username atau Password salah!</div>
  </div>
</div>

<div class="page" id="welcomePage">
  <div id="welcomeMessage">
    <h2>Selamat Datang! âœ¨</h2>
    <p>Halo <span id="displayUsername"></span>, senang Anda kembali! Jelajahi momen spesial dalam album digital ini.</p>
    <button id="startBrowsingBtn">Mulai Jelajahi Album</button>
  </div>
</div>

<div class="page" id="homePage">
  <div class="album-wrapper" id="folderSelectWrapper" style="display:flex; flex-direction:column; gap:20px; max-width:400px; padding:20px; opacity:1;">
    <div class="romantic-text" style="margin-bottom:0;">ğ—£ğ—œğ—Ÿğ—œğ—› ğ—™ğ—¢ğ—Ÿğ——ğ—˜ğ—¥ ğ—”ğ—Ÿğ—•ğ—¨ğ— </div>
    <button id="mainAlbumBtn" class="folder-btn">
        <span class="material-icons">folder_open</span> ALBUM UTAMA
    </button>
    <button id="folder1Btn" class="folder-btn">
        <span class="material-icons">folder_open</span> PAP RANDOM 1
    </button>
    <button id="folder2Btn" class="folder-btn">
        <span class="material-icons">folder_open</span> PAP RANDOM 2 
    </button>
  </div>
  
  <div class="album-wrapper" id="albumWrapper" style="display:none;">
    <button class="back-btn" onclick="showPage('home')">&#10094; KEMBALI</button>
    <div class="romantic-text">ğ’ğ–ğˆğğ„ ğ”ğ—¡ğ—§ğ—¨ğ— ğ— ğ—˜ğ—Ÿğ—œğ—›ğ—”ğ—§ ğ…ğ—¢ğ—§ğ—¢ ğ’ğ„ğ—Ÿğ—”ğ—¡ğ—ğ—¨ğ—§ğ—¡ğ˜ğ€</div>
    <div class="album-container" id="albumContainer">
      <div class="loading-spinner" id="mainSpinner"></div>
    </div>
    <div class="photo-indicator" id="mainPhotoIndicator"></div>
    <div class="photo-menu" id="photoMenu">
      <button id="shareBtn" title="Share"><span class="material-icons icon">share</span> Share</button>
      <button id="likeBtn" class="like-btn" title="Like"><span class="material-icons icon">favorite_border</span> Like</button>
      <button id="downloadBtn" title="Download"><span class="material-icons icon">cloud_download</span> Download</button>
    </div>
    <button class="nav-btn prev-btn" id="prevBtn">&#10094;</button>
    <button class="nav-btn next-btn" id="nextBtn">&#10095;</button>
  </div>
</div>

<div class="page" id="folder1Page">
  <button class="back-btn" onclick="showPage('home')">&#10094; KEMBALI</button>
  <div class="album-wrapper folder-album-wrapper" data-folder="folder1">
    <div class="romantic-text">ğ…ğğ‹ğƒğ„ğ‘ ğŸ - ğ’ğ–ğˆğğ„ ğ”ğ—¡ğ—§ğ—¨ğ— ğ— ğ—˜ğ—Ÿğ—œğ—›ğ—”ğ—§ ğ…ğ—¢ğ—§ğ—¢</div>
    <div class="album-container folder-album-container" id="folder1Container">
      <div class="loading-spinner" id="folder1Spinner"></div>
    </div>
    <div class="photo-indicator folder-photo-indicator" id="folder1PhotoIndicator"></div>
    <div class="photo-menu">
      <button onclick="sharePhoto('folder1')" title="Share"><span class="material-icons icon">share</span> Share</button>
      <button class="like-btn" data-folder="folder1" title="Like"><span class="material-icons icon">favorite_border</span> Like</button>
      <button onclick="downloadPhoto('folder1')" title="Download"><span class="material-icons icon">cloud_download</span> Download</button>
    </div>
    <button class="nav-btn prev-btn" onclick="navPhoto('folder1', -1)">&#10094;</button>
    <button class="nav-btn next-btn" onclick="navPhoto('folder1', 1)">&#10095;</button>
  </div>
</div>

<div class="page" id="folder2Page">
  <button class="back-btn" onclick="showPage('home')">&#10094; KEMBALI</button>
  <div class="album-wrapper folder-album-wrapper" data-folder="folder2">
    <div class="romantic-text">ğ…ğğ‹ğƒğ„ğ‘ ğŸ - ğ’ğ–ğˆğğ„ ğ”ğ—¡ğ—§ğ—¨ğ— ğ— ğ—˜ğ—Ÿğ—œğ—›ğ—”ğ—§ ğ…ğ—¢ğ—§ğ—¢</div>
    <div class="album-container folder-album-container" id="folder2Container">
      <div class="loading-spinner" id="folder2Spinner"></div>
    </div>
    <div class="photo-indicator folder-photo-indicator" id="folder2PhotoIndicator"></div>
    <div class="photo-menu">
      <button onclick="sharePhoto('folder2')" title="Share"><span class="material-icons icon">share</span> Share</button>
      <button class="like-btn" data-folder="folder2" title="Like"><span class="material-icons icon">favorite_border</span> Like</button>
      <button onclick="downloadPhoto('folder2')" title="Download"><span class="material-icons icon">cloud_download</span> Download</button>
    </div>
    <button class="nav-btn prev-btn" onclick="navPhoto('folder2', -1)">&#10094;</button>
    <button class="nav-btn next-btn" onclick="navPhoto('folder2', 1)">&#10095;</button>
  </div>
</div>

<div class="page" id="aboutPage">
  <button class="back-btn" onclick="showPage('home')">&#10094; KEMBALI</button>
  <div class="info-box">
    <h2>About</h2>
    <p>Developer: <strong>Nando Developers</strong></p>
    <p>ğ€ğ‹ğğ—¨ğ—  ğƒğˆğ—šğ—œğ—§ğ—”ğ‹ ğğ˜ ğ‚ğ—˜ğ—Ÿğ—­</p>
    <p>Versi: 3.2 Final
  </div>
</div>

<div class="page" id="contactPage">
  <button class="back-btn" onclick="showPage('home')">&#10094; KEMBALI</button>
  <div class="info-box">
    <h2>Contact</h2>
    <p>Email: <a href="mailto:arcelbussines@email.com">arcelbussines@email.com</a></p>
    <p>Telegram: <a href="https://t.me/humans26" target="_blank">@humans26</a></p>
    <p>Jangan sungkan untuk menghubungi kami!</p>
  </div>
</div>

<div class="page" id="selectChatPage">
    <button class="back-btn" onclick="showChatBack()">
        <span class="material-icons">arrow_back</span> KEMBALI
    </button>
    <div class="info-box" style="max-width: 400px; height: auto;">
        <h2>Pilih Kontak Chat ğŸ’¬</h2>
        <p style="font-size: 0.9em; margin-bottom: 20px;">Pilih siapa yang ingin Anda hubungi:</p>
        <div id="contactList">
            </div>
    </div>
</div>

<div class="page" id="chatPage">
    <button class="back-btn" onclick="showChatBack()">
        <span class="material-icons">arrow_back</span> KEMBALI
    </button>
    <div class="info-box">
        
        <div id="chatHeader">
            <div id="opponentAvatar" class="custom-avatar" style="width: 40px; height: 40px; margin: 0; border: none;"></div>
            <div>
                <h3 id="opponentName" style="margin: 0; color: #ffe3f1; font-weight: 700; font-size: 1.2em;">Memuat...</h3>
                <p id="chatStatus" style="margin: 0; font-size: 0.8em; color: rgba(255,255,255,0.7);">Menghubungkan...</p>
            </div>
            <button onclick="deleteAllChatHistory()" style="margin-left: auto; background: none; border: none; color: white; font-size: 1em; cursor: pointer;" title="Hapus Riwayat Chat">
                 <span class="material-icons">delete_sweep</span>
            </button>
        </div>

        <div id="chatMessages">
            <div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 0.8em;">-- Chat hanya berfungsi jika server backend berjalan di localhost:3000 --</div>
        </div>

        <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.2); display: flex; gap: 10px; align-items: center;">
            
            <button id="attachMediaBtn" style="padding: 10px; border-radius: 50%; width: 40px; height: 40px; background: #99c7ff; color: white; border: none; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center;">
                <span class="material-icons" style="font-size: 1.2em;">attach_file</span>
            </button>
            <input type="file" id="chatFileInput" accept="image/*, audio/*" style="display:none;">
            <input type="text" id="chatInput" placeholder="Ketik pesan..." style="flex-grow: 1; padding: 12px 18px; border-radius: 20px; border: none; background: rgba(255,255,255,0.5); color: #333; outline: none;">
            
            <button id="sendChatBtn" style="padding: 10px 15px; border-radius: 50%; width: 40px; height: 40px; background: #ff99c7; color: white; border: none; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center;">
                <span class="material-icons" style="font-size: 1.2em;">send</span>
            </button>
        </div>
    </div>
</div>

<div class="page" id="zazaAIPage">
    <button class="back-btn" onclick="showPage('home')">
        <span class="material-icons">arrow_back</span> KEMBALI
    </button>
    <div class="info-box">
        
        <div id="zazaAIHeader">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: #99c7ff; color: white; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 1.2em;">Z</div>
            <div>
                <h3 style="margin: 0; color: #99c7ff; font-weight: 700; font-size: 1.2em;">Tanya Zaza AI</h3>
                <p style="margin: 0; font-size: 0.8em; color: rgba(255,255,255,0.7);">Tanya apa saja, Zaza AI siap menjawab!</p>
            </div>
        </div>

        <div id="zazaAIMessages">
             <div class="ai-bubble-zaza">Halo! Saya Zaza AI, asisten virtual Anda. Tanyakan apa saja!</div>
             </div>

        <div class="zaza-ai-footer">
            <input type="text" id="zazaAIInput" placeholder="Tanyakan pada Zaza AI..." style="flex-grow: 1; padding: 12px 18px; border-radius: 20px; border: none; background: rgba(255,255,255,0.5); color: #333; outline: none;">
            
            <button id="sendZazaAIBtn" style="padding: 10px 15px; border-radius: 50%; width: 40px; height: 40px; background: #99c7ff; color: white; border: none; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center;">
                <span class="material-icons" style="font-size: 1.2em;">send</span>
            </button>
        </div>
    </div>
</div>


<div class="page" id="statusPage">
    <button class="back-btn" onclick="showPage('home')">
        <span class="material-icons">arrow_back</span> KEMBALI
    </button>
    <div class="info-box">
        <h2>Stories (Status) âœ¨</h2>
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button id="createMediaStatusBtn" class="folder-btn" style="width:50%; background:#4CAF50; padding:12px 20px; font-size:1em;">
                <span class="material-icons">add_photo_alternate</span> Status Media
            </button>
            <button id="createTextStatusBtn" class="folder-btn" style="width:50%; background:#00bcd4; padding:12px 20px; font-size:1em;">
                <span class="material-icons">notes</span> Status Kata-kata
            </button>
        </div>

        <input type="file" id="statusFileInput" accept="image/*,audio/*" style="display:none;">
        <div id="statusList">
            <div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 0.9em;">Memuat status...</div>
        </div>
    </div>
</div>

<div class="page" id="profilePage">
    <button class="back-btn" onclick="showPage('home')">
        <span class="material-icons">arrow_back</span> KEMBALI
    </button>
    <div class="info-box" id="profileBox">
        <h2>Profil Pengguna ğŸ‘¤</h2>
        <div id="profileAvatar" class="custom-avatar"></div>
        <h3 id="profileName" style="color:#ffe3f1; font-size:1.8em; margin-bottom: 5px;"></h3>
        <p id="profileRole" style="font-size:1.1em; color: rgba(255,255,255,0.8);"></p>
        <p id="profileStatus" style="font-style: italic; margin-top: 15px;">"Mengejar mimpi dan cinta."</p>
        <button id="editProfileBtn" class="folder-btn" style="width:100%; margin-top:20px; background:#4CAF50;">
            <span class="material-icons">edit</span> Edit Nama / Bio & Avatar
        </button>
    </div>
</div>

<div id="editProfileModal">
    <div id="editProfileContent">
        <h3>Edit Profil Anda</h3>
        <input type="text" id="editNameInput" placeholder="Nama Panggilan">
        <textarea id="editBioInput" placeholder="Bio Singkat (Max 50 karakter)" maxlength="50"></textarea>
        <input type="text" id="editRoleInput" placeholder="Role (Hanya untuk Zaza/Khirza)" style="display:none;">
        
        <label for="editAvatarInput" style="display:flex; align-items:center; gap:10px; cursor:pointer; color:#ffc0de; font-weight:600;">
            <span class="material-icons">photo_camera</span> Ganti Foto Profil
        </label>
        <input type="file" id="editAvatarInput" accept="image/*" style="display:none;">
        
        <button id="saveProfileBtn">Simpan Perubahan</button>
        <button onclick="document.getElementById('editProfileModal').style.display='none';" style="background:#ff6f91;">Batal</button>
    </div>
</div>

<div id="viewProfileModal">
    <div id="viewProfileContent">
        <div id="viewProfileAvatar" class="custom-avatar" style="margin-bottom: 0;"></div>
        <h3 id="viewProfileName" style="color:#ffc0de; margin-top: 10px;">Nama Pengguna</h3>
        <p id="viewProfileRole" style="font-size:1em; color: rgba(255,255,255,0.8); margin-bottom: 5px;"></p>
        <p id="viewProfileBio" style="font-style: italic; margin-top: 0; font-size: 0.9em;">"Bio Singkat"</p>
        
        <button onclick="document.getElementById('viewProfileModal').style.display='none';" style="background:#ff99c7;">Tutup</button>
    </div>
</div>


<div id="statusViewer">
    <div id="viewerContent">
        <h3 id="viewerHeader" style="color:#ffc0de;">Status dari <span id="viewerSender"></span> <span id="viewerTime" style="font-size: 0.6em; color: rgba(255,255,255,0.5);"></span></h3>
        
        <img id="viewerMedia" src="" alt="Status Media" style="display:none;">
        <audio id="viewerAudio" controls style="width: 100%; margin-bottom: 15px; display:none;"></audio>
        <p id="viewerMessage" style="font-size:1.1em; margin: 15px 0;"></p>
        
        <div id="viewerMeta">
            <p id="viewerLikes"><span class="material-icons" style="font-size:0.9em; vertical-align:middle;">favorite</span> <span id="likeCount">0</span> Suka</p>
            <p id="viewerViews"><span class="material-icons" style="font-size:0.9em; vertical-align:middle;">visibility</span> <span id="viewCount">0</span> Dilihat</p>
        </div>
        
        <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
             <button id="statusLikeBtn"><span class="material-icons" style="font-size: 1.1em; vertical-align:middle;">favorite</span> Like</button>
             <button id="statusReplyBtn"><span class="material-icons" style="font-size: 1.1em; vertical-align:middle;">reply</span> Reply</button>
             <button id="deleteStatusBtn" style="display:none;"><span class="material-icons" style="font-size: 1.1em; vertical-align:middle;">delete</span> Hapus</button>
        </div>

        <div id="replySection" style="margin-top: 20px; display: none; align-items: center; gap: 10px;">
            <input type="text" id="statusReplyInput" placeholder="Kirim balasan...">
            <button id="sendReplyBtn" style="padding: 10px; border-radius: 50%; width: 40px; height: 40px; background: #00bcd4; color: white; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center;">
                <span class="material-icons" style="font-size: 1.2em;">send</span>
            </button>
        </div>

        <button onclick="document.getElementById('statusViewer').style.display='none'; document.getElementById('viewerAudio').pause();" style="position:absolute; top:20px; right:20px; background:none; border:none; color:white; font-size:2em; cursor:pointer;">&times;</button>
    </div>
</div>

<audio id="bgMusic" src="https://h.top4top.io/m_35969emdf0.m4a" loop></audio>

<script>
// --- KONFIGURASI SUPABASE (FRONTEND CLIENT) ---
// Gunakan Anon Key untuk READ access dari sisi client
const SUPABASE_URL = 'https://bcxpccxcjjcezjocvqbu.supabase.co';
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjeHBjY3hjampjZXpqb2N2cWJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MDM0NTMsImV4cCI6MjA3ODI3OTQ1M30.ExnimOx8Ol3-SeNivElzdQqMoo7pyPMbje5TZZSG1TQ"; 

// Inisialisasi Supabase Client
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- KONFIGURASI CHAT & LOGIN ---
const CHAT_SERVER_URL = 'https://arcell-production.up.railway.app'; 
const socket = io(CHAT_SERVER_URL);  

const loginCredentials = {
  'zaza': 'zaza',      
  'khirza': 'cantik',
  'anomali1': 'anomali1', 
  'anomali2': 'anomali2', 
  'anomali3': 'anomali3'  
};

// Default Profiles
const DEFAULT_USER_PROFILES = {
    'zaza': { id: 'zaza', name: 'Zaza', isVerified: true, avatar: 'ZA', role: 'Software Engineer', bio: 'Mengejar mimpi dan cinta.', lastSeen: null, isOnline: false },
    'khirza': { id: 'khirza', name: 'Khirza', isVerified: false, avatar: 'KH', role: 'Mahasiswa', bio: 'Selalu semangat dan tersenyum.', lastSeen: null, isOnline: false },
    'anomali1': { id: 'anomali1', name: 'Anomali 1', isVerified: false, avatar: '1', role: 'Pengguna', bio: 'Saya adalah anomali pertama.', lastSeen: null, isOnline: false }, 
    'anomali2': { id: 'anomali2', name: 'Anomali 2', isVerified: false, avatar: '2', role: 'Pengguna', bio: 'Saya adalah anomali kedua.', lastSeen: null, isOnline: false }, 
    'anomali3': { id: 'anomali3', name: 'Anomali 3', isVerified: false, avatar: '3', role: 'Pengguna', bio: 'Saya adalah anomali ketiga.', lastSeen: null, isOnline: false }  
};

let CHAT_USER_PROFILES = JSON.parse(JSON.stringify(DEFAULT_USER_PROFILES)); 

let myUserId = ''; 
let myUserName = '';
let opponentInfo = {}; 
let currentOpponentId = ''; 
const STATUS_KEY = 'globalUserStatuses'; 
let currentStatusId = null; 
// --- END KONFIGURASI ---

// Fungsi utilitas untuk mendapatkan kunci localStorage (Hanya untuk Album Like & Zaza AI History)
function getLocalStorageKey(key) { return `${myUserId}_${key}`; }

// Hapus getChatHistoryKey karena kita pakai Supabase

// Navbar toggle
const navMenu = document.getElementById('navMenu');
const menuToggle = document.getElementById('menuToggle');
menuToggle.addEventListener('click',()=> {
  navMenu.classList.toggle('active');
  menuToggle.classList.toggle('active');
});

// Pages 
const pages = { 
  login: document.getElementById('loginPage'), 
  welcome: document.getElementById('welcomePage'),
  home: document.getElementById('homePage'), 
  folder1: document.getElementById('folder1Page'),
  folder2: document.getElementById('folder2Page'),
  about: document.getElementById('aboutPage'), 
  contact: document.getElementById('contactPage'),
  chat: document.getElementById('chatPage'),
  status: document.getElementById('statusPage'),
  zazaAI: document.getElementById('zazaAIPage'),
  profile: document.getElementById('profilePage'),
  selectChat: document.getElementById('selectChatPage') 
};

// Data Album (Dipotong)
const albumData = {
  main: { 
    photos: [
      "https://images2.imgbox.com/07/6d/flAblCPU_o.jpg",
      "https://images2.imgbox.com/8a/48/5WnFlheI_o.jpg",
      "https://images2.imgbox.com/17/93/x3zJwzr8_o.jpg",
      "https://images2.imgbox.com/9f/c4/0HZK3fj6_o.jpg",
      "https://images2.imgbox.com/d4/f3/y30RHo1v_o.jpg",
      "https://images2.imgbox.com/d0/ef/utCLLETK_o.jpg",
      "https://images2.imgbox.com/6d/9d/TfuuSkGT_o.jpg",
      "https://images2.imgbox.com/9b/14/1Nh4stjQ_o.jpg",
      "https://images2.imgbox.com/05/cf/2lmZVoK0_o.jpg",
      "https://images2.imgbox.box.com/17/ad/VpSegle2_o.jpg",
      "https://images2.imgbox.com/bf/38/j28lslL7_o.jpg",
      "https://images2.imgbox.com/2d/5d/THVip0wB_o.jpg",
      "https://images2.imgbox.com/d1/42/8VgLikp_o.jpg", 
      "https://images2.imgbox.com/15/a4/Aj6Q76RP_o.jpg",
      "https://images2.imgbox.com/31/7d/DaZ3wHmd_o.jpg",
      "https://images2.imgbox.com/ac/73/goBnuRIx_o.jpg",
      "https://images2.imgbox.com/aa/b9/HsnXJMTE_o.jpg",
      "https://images2.imgbox.com/9d/1e/44qSzju4_o.jpg",
      "https://images2.imgbox.com/94/ec/28ile6qy_o.jpg",
      "https://images2.imgbox.com/b7/2c/3EgN6c1L_o.jpg",
      "https://images2.imgbox.com/09/6a/BJdQjfwc_o.jpg",
      "https://images2.imgbox.com/7a/11/Example22_o.jpg", 
      "https://files.catbox.moe/q9mv31.jpg", 
      "https://files.catbox.moe/gkx423.jpg",
      "https://files.catbox.moe/cohstd.jpg",
      "https://files.catbox.moe/aynt0u.jpg",
      "https://files.catbox.moe/m78c8s.jpg" 
    ], 
    current: 0, 
    likedPhotos: [], 
    container: document.getElementById('albumContainer'), 
    indicator: document.getElementById('mainPhotoIndicator'), 
    spinner: document.getElementById('mainSpinner'),
    likeBtnElement: document.getElementById('likeBtn')
  },
  folder1: { 
    photos: [ 
      "https://files.catbox.moe/a8103e.jpg",
      "https://files.catbox.moe/xrgsju.jpg",
      "https://files.catbox.moe/66gyub.jpg",
      "https://files.catbox.moe/kwhj0y.jpg",
      "https://files.catbox.moe/53xopd.jpg",
      "https://files.catbox.moe/vavwon.jpg",
      "https://files.catbox.moe/qs8hz8.jpg",
      "https://files.catbox.moe/vye5u2.jpg",
      "https://files.catbox.moe/62lajf.jpg",
      "https://files.catbox.moe/ieldvp.jpg",
      "https://files.catbox.moe/gbpaup.jpg", 
      "https://files.catbox.moe/jxcxec.jpg", 
      "https://files.catbox.moe/mrebfs.jpg", 
      "https://files.catbox.moe/j2u52c.jpg"
    ], 
    current: 0, 
    likedPhotos: [], 
    container: null, 
    indicator: null, 
    spinner: null,
    likeBtnElement: null
  },
  folder2: { 
    photos: [ 
      "https://files.catbox.moe/ieldvp.jpg",
      "https://files.catbox.moe/6ldfhh.jpg",
      "https://files.catbox.moe/250ug0.jpg",
      "https://files.catbox.moe/zklaxg.jpg",
      "https://files.catbox.moe/n5682x.jpg",
      "https://files.catbox.moe/rdgmp9.jpg", 
      "https://files.catbox.moe/j2u52c.jpg", 
      "https://files.catbox.moe/f30pak.jpg", 
      "https://files.catbox.moe/gbpaup.jpg", 
      "https://files.catbox.moe/jxcxec.jpg"
    ], 
    current: 0, 
    likedPhotos: [], 
    container: null, 
    indicator: null, 
    spinner: null,
    likeBtnElement: null
  }
};

let autoSwipeInterval;
let lastTap = 0; 

// Menggunakan kunci universal untuk status like album
const GLOBAL_PROFILE_KEY = 'CHAT_USER_PROFILES_CUSTOM';


function loadLikeStatus(folder) {
    // Menggunakan kunci per user untuk data non-universal
    const key = getLocalStorageKey(`${folder}_likedPhotos`);
    const storedLikes = localStorage.getItem(key);
    if (storedLikes) {
        albumData[folder].likedPhotos = JSON.parse(storedLikes);
    } else {
        albumData[folder].likedPhotos = [];
    }
}

function saveLikeStatus(folder) {
    // Menggunakan kunci per user untuk data non-universal
    const key = getLocalStorageKey(`${folder}_likedPhotos`);
    localStorage.setItem(key, JSON.stringify(albumData[folder].likedPhotos));
}

function loadUserProfiles() {
    // 1. Reset ke Default
    CHAT_USER_PROFILES = JSON.parse(JSON.stringify(DEFAULT_USER_PROFILES));
    
    // 2. Muat Kustomisasi Global
    const storedProfiles = localStorage.getItem(GLOBAL_PROFILE_KEY);
    if (storedProfiles) {
        const customProfiles = JSON.parse(storedProfiles);
        
        // Gabungkan profil kustom dengan default
        Object.keys(customProfiles).forEach(userId => {
             if (CHAT_USER_PROFILES[userId]) {
                // Pertahankan properti non-kustomizable (isVerified, lastSeen, isOnline)
                const defaultProfile = DEFAULT_USER_PROFILES[userId];
                
                CHAT_USER_PROFILES[userId] = { 
                    ...defaultProfile, // Mulai dari default
                    ...customProfiles[userId] // Timpa dengan kustomisasi (nama, bio, avatar, role)
                };
             }
        });
    }
    // Catatan: isOnline/lastSeen diperbarui oleh socket 'user_status_update', tidak disimpan di sini.
}

function saveUserProfiles() {
    const customProfiles = {};

    for (const userId in CHAT_USER_PROFILES) {
         const current = CHAT_USER_PROFILES[userId];
         const defaultP = DEFAULT_USER_PROFILES[userId];
         
         // Cek apakah ada perubahan pada field yang dapat diedit pengguna (name, bio, avatar, role)
         if (!defaultP || 
             current.name !== defaultP.name || 
             current.bio !== defaultP.bio ||
             current.avatar !== defaultP.avatar ||
             current.role !== defaultP.role 
             ) 
         {
              // Simpan hanya field yang relevan untuk kustomisasi
              customProfiles[userId] = { 
                  id: current.id, 
                  name: current.name, 
                  isVerified: current.isVerified, 
                  avatar: current.avatar, 
                  role: current.role, 
                  bio: current.bio, 
              };
         }
    }
    localStorage.setItem(GLOBAL_PROFILE_KEY, JSON.stringify(customProfiles));
    
    // Perbarui profil pengguna sendiri setelah menyimpan
    const myProfile = CHAT_USER_PROFILES[myUserId];
    if (myProfile) {
        myUserName = myProfile.name;
    }
}

function getOpponentId() {
    return currentOpponentId; 
}

function selectOpponent(opponentId) {
    currentOpponentId = opponentId;
    localStorage.setItem(getLocalStorageKey('currentOpponentId'), opponentId); 
    showPage('chat'); 
    loadChatHistory();
}

function showChatBack() {
    // Kembali ke Select Chat Page untuk semua user
    showPage('selectChat');
}


// **INICIALISASI SAAT STARTUP (SESI PERSISTENCE)**
window.onload = () => {
    loadUserProfiles(); 
    
    albumData.folder1.likeBtnElement = document.querySelector('#folder1Page .like-btn');
    albumData.folder2.likeBtnElement = document.querySelector('#folder2Page .like-btn');
    
    albumData.folder1.likeBtnElement.onclick = () => toggleLike('folder1');
    albumData.folder2.likeBtnElement.onclick = () => toggleLike('folder2');

    const storedUser = localStorage.getItem('loggedInUser');
    if (storedUser && loginCredentials[storedUser]) {
        myUserId = storedUser;
        loadUserProfiles(); // Muat ulang setelah myUserId disetel
        myUserName = CHAT_USER_PROFILES[myUserId].name;
        document.querySelector('.navbar').style.display = 'flex';
        document.getElementById('displayUsername').textContent = myUserName.toUpperCase();
        
        currentOpponentId = localStorage.getItem(getLocalStorageKey('currentOpponentId')) || ''; 
        
        showPage('welcome');
        socket.emit('user_login', myUserId);
    } else {
        showPage('login');
    }
    
    loadLikeStatus('main');
    loadLikeStatus('folder1');
    loadLikeStatus('folder2');

    loadZazaAIChatHistory();
    // GANTI: Panggil updateChatHeader saat memuat halaman chat/saat ada perubahan user_status_update dari socket
    // setInterval(updateChatHeader, 5000); 
};


// Login (Dipotong)
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const togglePass = document.getElementById('togglePass');
const albumWrapper = document.getElementById('albumWrapper'); 
const folderSelectWrapper = document.getElementById('folderSelectWrapper');
const music = document.getElementById('bgMusic');
const displayUsername = document.getElementById('displayUsername');
const startBrowsingBtn = document.getElementById('startBrowsingBtn');
const createTextStatusBtn = document.getElementById('createTextStatusBtn'); // Baru

togglePass.addEventListener('click', ()=>{
  passwordInput.type = (passwordInput.type==='password')?'text':'password'; 
  togglePass.textContent = (passwordInput.type==='password')?'Show Password':'Hide Password'; 
});

loginBtn.addEventListener('click', ()=>{
  const user = usernameInput.value.trim();
  const pass = passwordInput.value.trim();
  
  if(loginCredentials[user] === pass){ 
    loginError.style.display='none';
    document.querySelector('.navbar').style.display='flex';
    
    myUserId = user; 
    loadUserProfiles(); 
    myUserName = CHAT_USER_PROFILES[user].name;
    localStorage.setItem('loggedInUser', user); 
    
    displayUsername.textContent = myUserName.toUpperCase(); 
    
    socket.emit('user_login', myUserId);
    
    loadLikeStatus('main');
    loadLikeStatus('folder1');
    loadLikeStatus('folder2');
    
    // Default opponent saat login (digunakan jika belum pernah memilih)
    if (myUserId === 'zaza') currentOpponentId = 'khirza';
    else if (myUserId === 'khirza') currentOpponentId = 'zaza';
    else currentOpponentId = 'zaza'; // Default untuk Anomali

    localStorage.setItem(getLocalStorageKey('currentOpponentId'), currentOpponentId); 
        
    showPage('welcome'); 
  } else {
    loginError.style.display='block';
  }
});

document.getElementById('startBrowsingBtn').addEventListener('click', () => { 
    if (myUserId === 'zaza' || myUserId === 'khirza') {
        showPage('home'); 
    } else {
        alert('Anda tidak memiliki izin untuk mengakses album. Hanya Zaza dan Khirza yang dapat melihat album.');
        showPage('profile'); 
    }
});

// **LOGOUT**
document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('loggedInUser'); 
    // Hapus juga cache lawan saat logout
    localStorage.removeItem(getLocalStorageKey('currentOpponentId')); 
    socket.emit('user_logout', myUserId); 
    myUserId = '';
    myUserName = '';
    currentOpponentId = '';
    document.querySelector('.navbar').style.display = 'none';
    music.pause();
    showPage('login');
});

// FUNGSI Render Avatar & Profile (Dipotong)
function renderAvatar(element, profile) {
    if (profile.avatar && profile.avatar.startsWith('data:image')) {
        element.style.backgroundImage = `url(${profile.avatar})`;
        element.style.backgroundSize = 'cover';
        element.style.backgroundColor = 'transparent';
        element.textContent = '';
    } else {
        element.style.backgroundImage = 'none';
        element.style.backgroundColor = '#ff99c7';
        element.textContent = profile.avatar; 
    }
    // Pastikan avatar di luar chat selalu bulat
    element.style.borderRadius = '50%'; 
}

function showProfilePage() {
    loadUserProfiles(); 
    const profileData = CHAT_USER_PROFILES[myUserId];
    if (!profileData) return;
    
    const profileAvatarEl = document.getElementById('profileAvatar');
    renderAvatar(profileAvatarEl, profileData);

    document.getElementById('profileName').textContent = profileData.name;
    document.getElementById('profileRole').textContent = profileData.role;
    document.getElementById('profileStatus').textContent = `"${profileData.bio}"`;
}


// FUNGSI UTAMA UNTUK MENAMPILKAN HALAMAN (DIUBAH)
function showPage(page){
  clearInterval(autoSwipeInterval);
  
  const albumPages = ['home', 'mainAlbum', 'folder1', 'folder2'];
  
  if (albumPages.includes(page) && myUserId !== 'zaza' && myUserId !== 'khirza') {
      alert('Anda tidak memiliki izin untuk mengakses album.');
      return; 
  }
  
  for(const key in pages){ 
    pages[key].style.display = 'none';
    pages[key].classList.remove('active-page');
  }

  if (page === 'home' || page === 'mainAlbum') {
      pages['home'].style.display = 'flex';
      pages['home'].classList.add('active-page');
      
      if (page === 'home') {
           folderSelectWrapper.style.display = 'flex'; 
           albumWrapper.style.display = 'none';
      } else { 
           folderSelectWrapper.style.display = 'none';
           albumWrapper.style.display = 'block'; 
      }
  } else {
      pages[page].style.display = 'flex'; 
      pages[page].classList.add('active-page'); 
  }
  
  navMenu.classList.remove('active');
  menuToggle.classList.remove('active');
  
  if (page === 'selectChat') {
      renderContactList();
  }
  
  if (page === 'status') {
      renderStatusList();
  }
  
  if (page === 'chat') {
       loadChatHistory();
       updateChatHeader(); // PENTING: Panggil saat pindah ke halaman chat
  }
  
  if (page === 'profile') {
      showProfilePage();
  }

  if(albumPages.includes(page)) playMusicIfAlbum();
  else music.pause();
}


// FUNGSI ALBUM (Dipotong)
function showPhoto(folder, i){
    const data = albumData[folder];
    const container = data.container;
    const spinner = data.spinner;
    const photos = data.photos;

    container.querySelectorAll('.photo').forEach(p => p.remove());
    data.indicator.innerHTML = ''; 
    
    if (photos.length === 0) {
        container.innerHTML = '<div class="fallback-img">Tidak ada foto di folder ini.</div>';
        return;
    }

    const isLiked = data.likedPhotos.includes(i);
    spinner.style.display = 'block'; 

    photos.forEach((photoUrl, index) => { 
        const img = document.createElement('img');
        img.className = 'photo';
        img.src = photoUrl;
        img.alt = `Photo ${index + 1}`;
        
        if (index === i) {
            img.classList.add('active');
            data.current = i; 
        }

        img.onload = () => {
            if (index === i) {
                spinner.style.display = 'none';
            }
        };

        img.onerror = () => {
            console.error(`Gagal memuat foto: ${photoUrl}`);
            const fallback = document.createElement('div');
            fallback.className = 'photo active fallback-img';
            fallback.style.cssText = `z-index: ${index === i ? 2 : 0};`;
            fallback.textContent = `Foto ${index + 1} Gagal Dimuat`;
            container.appendChild(fallback);
             if (index === i) {
                spinner.style.display = 'none';
            }
        };
        
        container.appendChild(img);
    });

    updateLikeButton(data.likeBtnElement, isLiked);
}

function navPhoto(folder, direction){
    const data = albumData[folder];
    let newIndex = data.current + direction;
    
    if (newIndex < 0) newIndex = data.photos.length - 1;
    if (newIndex >= data.photos.length) newIndex = 0;
    
    resetAutoSwipe(folder);
    showPhoto(folder, newIndex);
    startAutoSwipe(folder);
}


function initMainAlbum(){
    const data = albumData['main'];
    
    data.container.innerHTML = `<div class="loading-spinner" id="mainSpinner"></div>`;
    data.indicator.innerHTML = '';
    showPhoto('main', data.current);
    setupSwipe(data.container, 'main');
    setupDoubleTap(data.container, 'main'); 
    startAutoSwipe('main');
    document.getElementById('albumWrapper').classList.add('show');
}

function initFolderAlbum(folder){
    const data = albumData[folder];
    data.container = document.getElementById(`${folder}Container`);
    data.indicator = document.getElementById(`${folder}PhotoIndicator`);
    data.spinner = document.getElementById(`${folder}Spinner`);
    
    data.container.innerHTML = `<div class="loading-spinner" id="${folder}Spinner"></div>`;
    data.indicator.innerHTML = '';
    
    showPhoto(folder, data.current);
    setupSwipe(data.container, folder);
    setupDoubleTap(data.container, folder); 
    startAutoSwipe(folder);
    document.querySelector(`#${folder}Page .album-wrapper`).classList.add('show');
}


function startAutoSwipe(folder){
    clearInterval(autoSwipeInterval);
    autoSwipeInterval = setInterval(() => {
        navPhoto(folder, 1);
    }, 5000); 
}

function resetAutoSwipe(folder){
    clearInterval(autoSwipeInterval);
}

function setupSwipe(element, folder){
    let startX;
    element.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        resetAutoSwipe(folder);
    });

    element.addEventListener('touchend', (e) => {
        const endX = e.changedTouches[0].clientX;
        const diff = endX - startX;
        
        if (Math.abs(diff) > 50) { 
            navPhoto(folder, diff < 0 ? 1 : -1); 
        }
        startAutoSwipe(folder); 
    });
}

function setupDoubleTap(element, folder) {
    element.addEventListener('touchend', (e) => {
        const now = new Date().getTime();
        const timesince = now - lastTap;
        
        if ((timesince < 300) && (timesince > 0)) {
            e.preventDefault(); 
            toggleLike(folder); 
            
            element.classList.add('double-tap-liked');
            setTimeout(() => {
                element.classList.remove('double-tap-liked');
            }, 800);
        }
        lastTap = now;
    });
    
    element.addEventListener('dblclick', (e) => {
        e.preventDefault();
        toggleLike(folder); 
        
        element.classList.add('double-tap-liked');
        setTimeout(() => {
            element.classList.remove('double-tap-liked');
            }, 800);
    });
}


// Folder Selection Buttons (Dipotong)
document.getElementById('mainAlbumBtn').onclick = ()=>{
    showPage('mainAlbum'); 
    initMainAlbum();
};
document.getElementById('folder1Btn').onclick = ()=>{
    showPage('folder1');
    initFolderAlbum('folder1');
};
document.getElementById('folder2Btn').onclick = ()=>{
    showPage('folder2');
    initFolderAlbum('folder2');
};

// Navbar buttons (DIUBAH)
const chatNavBtn = document.getElementById('chatNavBtn');
chatNavBtn.onclick=()=>{
    showPage('selectChat');
}; 
document.getElementById('statusNavBtn').onclick=()=>showPage('status');
document.getElementById('homeBtn').onclick=()=>showPage('home');
document.getElementById('aboutBtn').onclick=()=>showPage('about');
document.getElementById('contactBtn').onclick=()=>showPage('contact');
document.getElementById('zazaAIBtn').onclick=()=>showPage('zazaAI');
document.getElementById('profileNavBtn').onclick=()=>showPage('profile'); 

// Particle (Dipotong)
const particleContainer = document.getElementById('particleContainer');
function createParticle() {
  const p = document.createElement('div');
  p.className = 'particle';
  const size = Math.random() * 5 + 5;
  p.style.width = p.style.height = `${size}px`;
  p.style.left = `${Math.random() * 100}vw`;
  p.style.top = `${Math.random() * 100}vh`;
  p.style.animationDuration = `${Math.random() * 10 + 10}s`;
  p.style.setProperty('--x', `${(Math.random() - 0.5) * 200}px`);
  p.style.setProperty('--y', `${(Math.random() - 0.5) * 200}px`);
  p.style.opacity = Math.random() * 0.5 + 0.1;
  particleContainer.appendChild(p);
  setTimeout(() => p.remove(), 20000); 
}
for(let i=0;i<50;i++){ createParticle(); }


// Photo menu actions (Dipotong)
function updateLikeButton(button, isLiked){
    if (!button) return; 
    const icon = button.querySelector('.icon');
    
    if (isLiked) {
        button.classList.add('liked');
        icon.textContent = 'favorite'; 
        button.title = 'Unlike';
    } else {
        button.classList.remove('liked');
        icon.textContent = 'favorite_border'; 
        button.title = 'Like';
    }
}

function toggleLike(folder){
    const data = albumData[folder];
    const currentIndex = data.current;
    
    const isCurrentlyLiked = data.likedPhotos.includes(currentIndex);
    
    if (isCurrentlyLiked) {
        data.likedPhotos = data.likedPhotos.filter(index => index !== currentIndex);
        updateLikeButton(data.likeBtnElement, false);
    } else {
        data.likedPhotos.push(currentIndex);
        updateLikeButton(data.likeBtnElement, true);
    }
    
    saveLikeStatus(folder);
}

function sharePhoto(folder){
    const data = albumData[folder];
    const photoUrl = data.photos[data.current]; 
    if (navigator.share) {
        navigator.share({
            title: 'Lihat Momen Spesial Ini!',
            text: `Cek foto ini di album digital! Photo ${data.current + 1} dari Folder ${folder}.`,
            url: photoUrl,
        }).catch(error => console.error('Error sharing:', error));
    } else {
        alert('Fitur share tidak didukung di browser ini. Link foto: ' + photoUrl);
    }
}

function downloadPhoto(folder){
    const data = albumData[folder];
    const photoUrl = data.photos[data.current];
    const link = document.createElement('a');
    link.href = photoUrl;
    link.download = `Photo-${folder}-${data.current + 1}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    alert('Foto sedang diunduh!');
}

document.getElementById('likeBtn').onclick = () => toggleLike('main');
document.getElementById('shareBtn').onclick = () => sharePhoto('main');
document.getElementById('downloadBtn').onclick = () => downloadPhoto('main');
document.getElementById('prevBtn').onclick = () => navPhoto('main', -1);
document.getElementById('nextBtn').onclick = () => navPhoto('main', 1);

function playMusicIfAlbum(){
  music.play().catch(()=>{}); 
}
document.body.addEventListener('click', ()=>{ music.play(); }, {once:true});


// **CHAT PERSISTENCE & DELETE & MEDIA**
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChatBtn');
const chatMessages = document.getElementById('chatMessages');
const chatStatus = document.getElementById('chatStatus');
const opponentNameEl = document.getElementById('opponentName');
const opponentAvatarEl = document.getElementById('opponentAvatar');
const chatFileInput = document.getElementById('chatFileInput');
const attachMediaBtn = document.getElementById('attachMediaBtn');
const contactListEl = document.getElementById('contactList'); 


/**
 * Memuat riwayat chat dari Supabase.
 * Menggantikan fungsi lama yang menggunakan localStorage.
 */
async function loadChatHistory() {
    const opponentId = getOpponentId();
    if (!opponentId) {
        chatMessages.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 0.8em;">-- Silakan pilih kontak chat --</div>';
        updateChatHeader();
        return;
    }
    
    chatMessages.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 0.8em; margin-bottom: 15px;">-- Memuat Riwayat Chat dari Supabase... --</div>';

    try {
        // Ambil semua pesan di mana: (sender = saya AND recipient = lawan) OR (sender = lawan AND recipient = saya)
        // Kita hanya mengambil kolom yang dibutuhkan di frontend
        const { data: history, error } = await supabaseClient 
            .from('messages')
            .select('id, sender_id, recipient_id, message_text, media_url, status, created_at')
            // Query OR: (myId to opponent) OR (opponent to myId)
            .or(`and(sender_id.eq.${myUserId},recipient_id.eq.${opponentId}),and(sender_id.eq.${opponentId},recipient_id.eq.${myUserId})`)
            .order('created_at', { ascending: true }); 
            
        if (error) {
            console.error("Error loading chat history from Supabase:", error);
            chatMessages.innerHTML = '<div style="text-align: center; color: #ff6f91; font-size: 0.9em;">Gagal memuat riwayat chat dari Supabase. Pastikan server backend berjalan.</div>';
            return;
        }

        chatMessages.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 0.8em; margin-bottom: 15px;">-- Chat dimulai --</div>';
        
        // Render history
        history.forEach(msg => {
            const formattedMsg = {
                // Gunakan created_at untuk ID sementara jika ID Supabase tidak dikirim via Socket
                id: Date.parse(msg.created_at), 
                senderId: msg.sender_id,
                recipientId: msg.recipient_id,
                message: msg.message_text,
                media: msg.media_url,
                timestamp: new Date(msg.created_at).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                status: msg.status 
            };
            addMessageToChat(formattedMsg, true);
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
        updateChatHeader();
        
        // PENTING: Kirim status 'read' ke backend untuk semua pesan lawan yang baru dimuat
        history.forEach(msg => {
            if (msg.sender_id === opponentId && msg.status !== 'read') {
                 // ID pesan harus dikirim dari backend, tapi kita bisa pakai timestamp sebagai fallback
                 socket.emit('message_read', { id: Date.parse(msg.created_at), senderId: msg.sender_id, recipientId: myUserId });
            }
        });

    } catch (e) {
        console.error("Kesalahan umum saat memuat Supabase:", e);
        chatMessages.innerHTML = '<div style="text-align: center; color: #ff6f91; font-size: 0.9em;">Kesalahan koneksi saat memuat riwayat.</div>';
    }
}

// Hapus saveChatHistory (karena kini di server.js)
// Hapus getChatHistoryKey (karena kini di server.js)

function deleteChatMessage(id) {
    if (confirm("Anda yakin ingin menghapus pesan ini? (Catatan: Ini tidak menghapus dari Supabase, hanya dari tampilan dan cache lokal)")) {
        const messageElement = document.getElementById(`msg-${id}`);
        if (messageElement) messageElement.remove();

        const opponentId = getOpponentId();
        // Hapus dari cache lokal (walaupun sudah tidak digunakan untuk load history)
        const historyKey = getLocalStorageKey(`chatHistory_${myUserId}_${opponentId}`);
        let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
        history = history.filter(msg => msg.id != id);
        localStorage.setItem(historyKey, JSON.stringify(history));
    }
}

function deleteAllChatHistory() {
    if (confirm("Anda yakin ingin menghapus SELURUH riwayat chat dengan pengguna ini? (CATATAN: Ini tidak menghapus dari Supabase, hanya dari tampilan)")) {
        
        // Catatan: Karena kita membaca dari Supabase, menghapus dari cache lokal tidak akan mencegah pemuatan ulang
        // Kecuali kita juga mengirim perintah DELETE ke server.
        
        // UNTUK SEMENTARA: Cuma hapus tampilan
        localStorage.removeItem(getLocalStorageKey(`chatHistory_${myUserId}_${getOpponentId()}`));
        loadChatHistory(); // Muat ulang chat dari Supabase
        alert("Riwayat chat berhasil dihapus (dari tampilan)!");
    }
}

// DITAMBAH: Fungsi untuk mendapatkan Last Seen yang diformat
function getFormattedLastSeen(timestamp) {
    const opponentProfile = CHAT_USER_PROFILES[currentOpponentId];
    if (opponentProfile && opponentProfile.isOnline) return 'Online âœ¨';

    if (!timestamp) return 'Offline';
    const now = new Date();
    const lastSeen = new Date(timestamp);
    const diffInSeconds = Math.floor((now - lastSeen) / 1000);

    if (diffInSeconds < 60) return 'Online'; // Anggap online jika kurang dari 1 menit
    if (diffInSeconds < 3600) return `Last seen ${Math.floor(diffInSeconds / 60)} minutes ago`;
    if (diffInSeconds < 86400) return `Last seen ${Math.floor(diffInSeconds / 3600)} hours ago`;

    // Format tanggal untuk lebih dari 1 hari
    return `Last seen ${lastSeen.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })} at ${lastSeen.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
}


function updateChatHeader() {
    loadUserProfiles(); 
    const opponentId = getOpponentId();
    
    if (!opponentId || !CHAT_USER_PROFILES[opponentId]) {
        opponentNameEl.textContent = 'Pilih Kontak';
        opponentAvatarEl.textContent = '?';
        opponentAvatarEl.style.backgroundColor = '#ccc';
        chatStatus.textContent = 'Tidak Ada Koneksi';
        chatStatus.style.color = '#ffc0de';
        return;
    }
    
    opponentInfo = CHAT_USER_PROFILES[opponentId];
    
    if (opponentInfo) {
        opponentNameEl.innerHTML = opponentInfo.name + (opponentInfo.isVerified ? ' <span class="material-icons" style="font-size: 1em; color: #7aff7a; vertical-align: middle;">verified</span>' : '');
        renderAvatar(opponentAvatarEl, opponentInfo); 
        opponentAvatarEl.style.width = '40px';
        opponentAvatarEl.style.height = '40px';
        opponentAvatarEl.style.margin = '0';
        opponentAvatarEl.classList.remove('custom-avatar'); 
        
        // DITAMBAH: Logika status/last seen
        const isOnline = opponentInfo.isOnline; 
        const lastSeen = opponentInfo.lastSeen;
        
        if (isOnline) {
            chatStatus.textContent = 'Online âœ¨';
            chatStatus.style.color = '#7aff7a';
        } else {
            chatStatus.textContent = getFormattedLastSeen(lastSeen);
            chatStatus.style.color = 'rgba(255,255,255,0.7)';
        }
    }
}

// FUNGSI RENDER KONTAK (PENAMBAHAN)
function renderContactList() {
    loadUserProfiles(); // Pastikan profil terbaru dimuat sebelum merender
    contactListEl.innerHTML = '';
    
    // Ambil semua ID kecuali ID sendiri
    const contactIds = Object.keys(CHAT_USER_PROFILES).filter(id => id !== myUserId);
    
    contactIds.forEach(id => {
        const profile = CHAT_USER_PROFILES[id];
        const item = document.createElement('div');
        item.classList.add('chat-contact-item');
        item.onclick = () => selectOpponent(id);
        
        const avatarDiv = document.createElement('div');
        avatarDiv.classList.add('contact-avatar');
        renderAvatar(avatarDiv, profile); 
        
        const infoDiv = document.createElement('div');
        infoDiv.innerHTML = `
            <h4 style="margin: 0; color: white;">${profile.name} ${profile.isVerified ? '<span class="material-icons" style="font-size: 0.8em; color: #7aff7a; vertical-align: middle;">verified</span>' : ''}</h4>
            <p style="margin: 2px 0 0; font-size: 0.9em; color: rgba(255,255,255,0.7);">${profile.role}</p>
        `;
        
        item.appendChild(avatarDiv);
        item.appendChild(infoDiv);
        contactListEl.appendChild(item);
    });
}


// FUNGSI CHAT DENGAN MEDIA (DIUBAH UNTUK LAYOUT BARU & GAYA WA)
function addMessageToChat(data, isHistory = false) {
    const { message, media, timestamp, senderId, status, id } = data; // PENTING: Ambil 'id'
    const isMe = senderId === myUserId;
    const messageId = id;
    const timeDisplay = timestamp || new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

    // FIX: Hapus pesan sementara yang mungkin sudah ada
    const existingMsg = document.getElementById(`msg-${messageId}`);
    if (existingMsg) existingMsg.remove(); 

    const msgDiv = document.createElement('div');
    msgDiv.classList.add('chat-bubble');
    msgDiv.id = `msg-${messageId}`; // ID permanen
    msgDiv.classList.add(isMe ? 'is-me' : 'is-opponent');


    const innerBubble = document.createElement('div');
    innerBubble.classList.add('chat-bubble-inner');
    
    let contentHTML = '';
    
    if (media) {
        const fileType = media.startsWith('data:audio') ? 'audio' : (media.startsWith('data:image') ? 'image' : 'file');
        
        if (fileType === 'image') {
            contentHTML += `<img src="${media}" class="media-message" alt="Image File" style="max-width: 180px; max-height: 180px; display: block; border-radius: 8px;">`;
            if (message) { 
                 contentHTML += `<div style="margin-top: 5px; color: ${isMe ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.8)'};">${message}</div>`;
            }
        } else if (fileType === 'audio') {
            const fileName = message || "Audio File";
            contentHTML += `
                <div style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: ${isMe ? 'white' : '#ff99c7'};">
                    <span class="material-icons" style="font-size: 1.5em; line-height: 1;">music_note</span>
                    <span style="flex-grow: 1;">${fileName}</span>
                </div>
                <audio controls src="${media}" style="width: 100%; margin-top: 5px;"></audio>
            `;
        } else { // File umum
            contentHTML += `
                <div style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: ${isMe ? 'white' : '#ff99c7'};">
                    <span class="material-icons" style="font-size: 1.5em; line-height: 1;">attach_file</span>
                    <span style="flex-grow: 1;">${message || 'File Attachment'}</span>
                </div>
            `;
        }
    } else {
        contentHTML += message;
    }
    
    // Tambahkan waktu dan status (hanya untuk pesan saya)
    let statusIcon = '';
    if (isMe) {
        let iconName = 'schedule';
        let iconStatus = 'schedule';
        
        if (status === 'read') {
            iconName = 'done_all';
            iconStatus = 'read';
        } else if (status === 'sent') {
            iconName = 'done_all';
            iconStatus = 'sent'; 
        } else {
             iconName = 'schedule';
             iconStatus = 'schedule';
        }

        statusIcon = `<span class="material-icons message-status" data-id="${messageId}" data-status="${iconStatus}" style="font-size: 1em; margin-left: 3px; vertical-align: middle;">${iconName}</span>`;
    }
    
    contentHTML += `
        <span style="display: block; font-size: 0.75em; margin-top: 5px; text-align: right; white-space: nowrap; color: ${isMe ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.6)'};">
            ${timeDisplay}
            ${statusIcon}
        </span>
    `;
    
    innerBubble.innerHTML = contentHTML;

    if (isMe) {
        // Pesan Saya (Inner bubble di kanan)
        msgDiv.appendChild(innerBubble);
        // Tombol hapus
        msgDiv.innerHTML += `<button class="delete-chat-btn" onclick="deleteChatMessage('${messageId}')">&times;</button>`; 
        
    } else {
        // Pesan Lawan Bicara (Hanya Inner bubble di kiri)
        msgDiv.appendChild(innerBubble); 
    }
    
    chatMessages.appendChild(msgDiv);
    if (!isHistory) chatMessages.scrollTop = chatMessages.scrollHeight;
}


function viewProfile(userId) {
    loadUserProfiles(); // Muat profil terbaru dari global storage
    const profile = CHAT_USER_PROFILES[userId];
    if (!profile) return;
    
    const modal = document.getElementById('viewProfileModal');
    const avatarEl = document.getElementById('viewProfileAvatar');
    
    renderAvatar(avatarEl, profile);
    avatarEl.style.width = '80px';
    avatarEl.style.height = '80px';
    avatarEl.style.margin = '0 auto 15px';
    avatarEl.classList.remove('custom-avatar'); 
    
    document.getElementById('viewProfileName').textContent = profile.name + (profile.isVerified ? ' (Verified)' : '');
    document.getElementById('viewProfileRole').textContent = profile.role; // Tampilkan Role
    document.getElementById('viewProfileBio').textContent = `"${profile.bio}"`;
    
    modal.style.display = 'flex';
}

// FIX: Perbaiki updateMessageStatus
function updateMessageStatus(data) {
    const statusIcon = document.querySelector(`.message-status[data-id="${data.id}"]`);
    if (statusIcon) {
        statusIcon.setAttribute('data-status', data.status);
        if (data.status === 'read') {
            statusIcon.textContent = 'done_all';
            statusIcon.style.color = '#00e676'; // Hijau
        } else if (data.status === 'sent') {
            statusIcon.textContent = 'done_all';
            statusIcon.style.color = 'rgba(255,255,255,0.8)'; // Putih/Abu-abu
        } else if (data.status === 'schedule') {
             statusIcon.textContent = 'schedule';
             statusIcon.style.color = 'rgba(255,255,255,0.8)'; // Putih/Abu-abu
        }
        
        // Kunci di localStorage yang terkait dengan riwayat chat (yang tidak lagi dipakai)
        const opponentId = getOpponentId();
        const historyKey = getLocalStorageKey(`chatHistory_${myUserId}_${opponentId}`);
        let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
        
        const msgIndex = history.findIndex(msg => msg.id == data.id);
        if (msgIndex !== -1) {
            history[msgIndex].status = data.status;
            localStorage.setItem(historyKey, JSON.stringify(history));
        }
    }
}

// --- SOCKET LISTENERS (PERBAIKAN KRITIS UNTUK CHAT) ---
socket.on('load_users', (usersData) => { 
    loadUserProfiles(); 
    // Ganti: Perbarui Last Seen/Online status
    Object.keys(usersData).forEach(id => {
        if (CHAT_USER_PROFILES[id]) {
            CHAT_USER_PROFILES[id].isOnline = usersData[id].isOnline;
            CHAT_USER_PROFILES[id].lastSeen = usersData[id].lastSeen;
        }
    });
    updateChatHeader(); // PENTING: Panggil setelah update status
});
socket.on('load_history', () => { loadChatHistory(); }); 

// KRITIS: Logika penyimpanan riwayat agar universal dan HANYA dirender dari Socket
socket.on('receive_message', (data) => { 
    // Hanya proses jika pesan melibatkan saya
    if (data.recipientId === myUserId || data.senderId === myUserId) { 
        
        const activeOpponent = getOpponentId();
        const isRelatedToActiveChat = (data.recipientId === activeOpponent && data.senderId === myUserId) ||
                                      (data.senderId === activeOpponent && data.recipientId === myUserId);
        
        // Tentukan lawan bicara
        let targetOpponentId = data.senderId === myUserId ? data.recipientId : data.senderId;
        
        // Gunakan kunci lokal untuk cache (opsional, karena riwayat dari Supabase)
        const historyKey = getLocalStorageKey(`chatHistory_${myUserId}_${targetOpponentId}`);
        
        let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
        
        let msgIndex = history.findIndex(msg => msg.id == data.id);
        
        // Jika pesan baru
        if (msgIndex === -1) { 
            history.push(data);
        } else {
             // Jika pesan sudah ada (misal update dari 'schedule' ke 'sent'), update datanya
             history[msgIndex] = data;
        }
        
        localStorage.setItem(historyKey, JSON.stringify(history));
        
        // Hanya render jika ini adalah chat yang aktif
        if(isRelatedToActiveChat) {
             addMessageToChat(data); 
        }
        
        // Jika saya adalah penerima, kirim 'read' status kembali ke pengirim (jika chat aktif)
        if(data.recipientId === myUserId && isRelatedToActiveChat) {
             // PENTING: Hanya kirim message_read jika statusnya belum 'read'
             if (data.status !== 'read') {
                 socket.emit('message_read', { id: data.id, senderId: data.senderId, recipientId: myUserId });
             }
        }
    }
});

// FIX: Perbarui Socket Listener
socket.on('update_status', (data) => { 
    // PENTING: Cek apakah ID lawan bicara saat ini sama dengan pengirim status
    const opponentId = getOpponentId();
    if (data.senderId === opponentId || data.recipientId === opponentId) {
        updateMessageStatus(data); 
    }
    
    // Perbarui status di localStorage untuk semua user yang terlibat
    const usersInvolved = [data.senderId, data.recipientId].filter(id => id === myUserId || id === getOpponentId());
    
    usersInvolved.forEach(user => {
         const historyKey = getLocalStorageKey(`chatHistory_${data.senderId}_${data.recipientId}`);
         let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
         const msgIndex = history.findIndex(msg => msg.id == data.id);
         
         if (msgIndex !== -1) {
              history[msgIndex].status = data.status;
              localStorage.setItem(historyKey, JSON.stringify(history));
         }
    });

});

// **BARU/DIPERBAIKI: SOCKET LISTENER UNTUK STATUS**
socket.on('receive_status_update', (senderId) => {
    // Klien lain menerima sinyal ini
    console.log(`Status baru diterima dari: ${senderId}. Memuat ulang daftar status...`);
    renderStatusList();
});

socket.on('user_status_update', (usersData) => {
    Object.keys(usersData).forEach(id => {
        if (CHAT_USER_PROFILES[id]) {
            CHAT_USER_PROFILES[id].isOnline = usersData[id].isOnline;
            CHAT_USER_PROFILES[id].lastSeen = usersData[id].lastSeen;
        }
    });
    updateChatHeader(); // PENTING: Panggil setiap kali status online/offline berubah
});

socket.on('receive_ai_message', (data) => {
    if (zazaAIMessages.lastChild && zazaAIMessages.lastChild.textContent.includes("Memproses permintaan Anda...")) {
        zazaAIMessages.lastChild.remove(); 
    }
    
    addMessageToZazaAIChat(data.message, data.sender);
    saveZazaAIChatHistory(data.message, data.sender);
});


// LOGIKA PENGIRIMAN MEDIA CHAT (DIUBAH - Hapus VN)
attachMediaBtn.addEventListener('click', () => {
    chatFileInput.click();
});

chatFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const opponentId = getOpponentId();
    if (!opponentId) {
        alert("Silakan pilih kontak chat terlebih dahulu!");
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (event) => {
        const mediaUrl = event.target.result;
        
        let message = "";
        
        // Atur caption/nama file
        if (file.type.startsWith('image/')) {
            message = prompt("Tambahkan Caption (Opsional):") || "";
        } else {
            // Untuk File/Audio, gunakan nama file sebagai pesan/label
            message = file.name || (file.type.startsWith('audio/') ? 'Audio File' : 'File Attachment');
            alert(`Mengirim file: ${message}`);
        }

        const messageData = {
            senderId: myUserId,
            recipientId: opponentId, 
            message: message,
            media: mediaUrl, 
            timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
            status: 'schedule', // FIX: Status awal adalah 'schedule' (mengirim)
            id: Date.now() // FIX: ID sementara
        };
        
        // Tampilkan pesan "schedule" sementara sebelum dikirim ke server
        addMessageToChat(messageData);
        
        // Kirim ke Socket.IO (Socket.IO akan membalas dengan ID real dan status 'sent')
        socket.emit('send_message', messageData);
        
        chatFileInput.value = ''; // Reset input
    };
    reader.readAsDataURL(file);
});


// --- EVENT HANDLER CHAT INPUT (PERBAIKAN KRITIS) ---
sendChatBtn.addEventListener('click', () => {
    const message = chatInput.value.trim();
    const opponentId = getOpponentId();

    if (!opponentId) {
        alert("Silakan pilih kontak chat terlebih dahulu!");
        return;
    }
    
    if (message !== '' && myUserId) {
        const messageData = {
            senderId: myUserId,
            recipientId: opponentId, 
            message: message,
            media: null, 
            timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
            status: 'schedule', // FIX: Status awal adalah 'schedule'
            id: Date.now() // FIX: ID sementara
        };

        // Tampilkan pesan "schedule" sementara sebelum dikirim ke server
        addMessageToChat(messageData);

        // Kirim ke Socket.IO (Socket.IO akan membalas dengan ID real dan status 'sent')
        socket.emit('send_message', messageData);

        chatInput.value = '';
    }
});
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendChatBtn.click();
});


// **FITUR STATUS (STORIES) MEDIA & TEKS (PERBAIKAN KRITIS UNTUK SHARING)**

// **FUNGSI BARU: Memicu pembaruan status ke klien lain melalui Socket**
function emitStatusUpdate() {
    socket.emit('status_created', { senderId: myUserId });
}

// --- STATUS TEKS BARU ---
createTextStatusBtn.addEventListener('click', () => {
    const text = prompt("Ketik status kata-kata Anda (Max 100 karakter):");
    if (text && text.trim().length > 0) {
        const statusData = {
            id: Date.now(),
            senderId: myUserId,
            senderName: myUserName,
            message: text.substring(0, 100), 
            media: null, // Status teks tidak ada media
            mediaType: 'text', // Tambah tipe media: text
            timestamp: new Date().toLocaleString('id-ID'),
            likes: [], 
            viewers: []
        };
        
        let allStatuses = JSON.parse(localStorage.getItem(STATUS_KEY) || '[]');
        allStatuses.unshift(statusData); 
        localStorage.setItem(STATUS_KEY, JSON.stringify(allStatuses));
        renderStatusList();
        
        // PENTING: Beri tahu klien lain!
        emitStatusUpdate(); 
    }
});

// --- STATUS MEDIA (REVISI) ---
const createMediaStatusBtn = document.getElementById('createMediaStatusBtn');
const statusFileInput = document.getElementById('statusFileInput');
const statusListEl = document.getElementById('statusList');

createMediaStatusBtn.addEventListener('click', () => {
    statusFileInput.click();
});

statusFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const mediaUrl = event.target.result;
            const caption = prompt(`Tambahkan Caption (Opsional) untuk ${file.type.startsWith('audio') ? 'Audio' : 'Media'}:`) || "";

            const statusData = {
                id: Date.now(),
                senderId: myUserId,
                senderName: myUserName,
                message: caption.substring(0, 100),
                media: mediaUrl, 
                mediaType: file.type.startsWith('audio') ? 'audio' : 'image', // Tambahkan tipe media
                timestamp: new Date().toLocaleString('id-ID'),
                likes: [], 
                viewers: []
            };
            
            let allStatuses = JSON.parse(localStorage.getItem(STATUS_KEY) || '[]');
            allStatuses.unshift(statusData); 
            localStorage.setItem(STATUS_KEY, JSON.stringify(allStatuses));
            renderStatusList();
            statusFileInput.value = ''; 

            // PENTING: Beri tahu klien lain!
            emitStatusUpdate(); 
        };
        reader.readAsDataURL(file);
    }
});


function renderStatusList() {
    statusListEl.innerHTML = '';
    
    // Status disimpan di localStorage GLOBAL (STATUS_KEY)
    const allStatuses = JSON.parse(localStorage.getItem(STATUS_KEY) || '[]');
    
    if (allStatuses.length === 0) {
        statusListEl.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 0.9em;">Belum ada status.</div>';
        return;
    }
    
    const groupedStatuses = {};
    allStatuses.forEach(status => {
        if (!groupedStatuses[status.senderId]) {
            groupedStatuses[status.senderId] = [];
        }
        groupedStatuses[status.senderId].push(status);
    });

    const sortedGroups = Object.keys(groupedStatuses).sort((a, b) => {
        if (a === myUserId) return -1;
        if (b === myUserId) return 1;
        return 0;
    });

    sortedGroups.forEach(senderId => {
        const group = groupedStatuses[senderId];
        const latestStatus = group.sort((a, b) => b.id - a.id)[0]; 
        const isMyStatus = senderId === myUserId;
        const isViewedByMe = latestStatus.viewers.includes(myUserId);
        
        const item = document.createElement('div');
        item.classList.add('status-item');
        item.setAttribute('data-id', latestStatus.id);
        
        if (latestStatus.viewers.includes(myUserId)) {
            item.classList.add('viewed');
        } else {
            item.classList.remove('viewed');
        }
        
        item.onclick = () => viewStatus(latestStatus.id); 
        
        const previewText = latestStatus.message.substring(0, 40) + (latestStatus.message.length > 40 ? '...' : '');

        let preview = '';
        if (latestStatus.mediaType === 'image') {
            preview = `<span class="material-icons" style="font-size:0.9em; vertical-align:middle; margin-right: 5px;">image</span> ${previewText || 'Foto Status'}`;
        } else if (latestStatus.mediaType === 'audio') {
            preview = `<span class="material-icons" style="font-size:0.9em; vertical-align:middle; margin-right: 5px;">music_note</span> ${previewText || 'Audio Status'}`;
        } else {
            preview = `<span class="material-icons" style="font-size:0.9em; vertical-align:middle; margin-right: 5px;">notes</span> ${previewText || 'Status Teks'}`;
        }


        item.innerHTML = `
            <div style="font-weight:700; color: #ffe3f1;">
                ${isMyStatus ? 'Status Saya' : latestStatus.senderName} 
            </div>
            <p style="margin:5px 0 0; font-size:1em; opacity: 0.9;">${preview}</p>
            <div class="status-meta">
                <span>${latestStatus.timestamp}</span>
                ${isMyStatus ? 
                    `<span class="viewed-icon">
                        <span class="material-icons" style="font-size:0.9em;">visibility</span> 
                        ${latestStatus.viewers.length} Dilihat
                    </span>`
                    : (isViewedByMe ? '' : '<span>Belum Dilihat</span>')
                }
            </div>
        `;
        
        statusListEl.appendChild(item);
    });
}

function viewStatus(id) {
    let allStatuses = JSON.parse(localStorage.getItem(STATUS_KEY) || '[]');
    const index = allStatuses.findIndex(s => s.id === id);
    if (index === -1) return;

    let status = allStatuses[index];
    currentStatusId = id;
    
    const viewerMediaEl = document.getElementById('viewerMedia');
    const viewerAudioEl = document.getElementById('viewerAudio');
    const deleteStatusBtn = document.getElementById('deleteStatusBtn');

    // Reset media
    viewerMediaEl.style.display = 'none';
    viewerAudioEl.style.display = 'none';
    viewerAudioEl.pause();
    
    if (status.mediaType === 'image') {
        viewerMediaEl.src = status.media;
        viewerMediaEl.style.display = 'block';
    } else if (status.mediaType === 'audio') {
        viewerAudioEl.src = status.media;
        viewerAudioEl.style.display = 'block';
        viewerAudioEl.play(); 
    }

    if (status.senderId !== myUserId && !status.viewers.includes(myUserId)) {
        status.viewers.push(myUserId);
        allStatuses[index] = status;
        localStorage.setItem(STATUS_KEY, JSON.stringify(allStatuses));
        renderStatusList(); 
    }
    
    document.getElementById('viewerSender').textContent = status.senderId === myUserId ? 'Anda' : status.senderName;
    document.getElementById('viewerTime').textContent = `(${status.timestamp})`;
    
    document.getElementById('viewerMessage').textContent = status.message || (status.mediaType === 'audio' ? 'Status Audio' : 'Status Media');
    document.getElementById('viewerMessage').style.display = status.message || status.media ? 'block' : 'none';

    document.getElementById('likeCount').textContent = status.likes.length;
    document.getElementById('viewCount').textContent = status.viewers.length;

    const likeBtn = document.getElementById('statusLikeBtn');
    const isLiked = status.likes.includes(myUserId);
    likeBtn.style.background = isLiked ? '#ff528a' : '#ff99c7';
    likeBtn.textContent = isLiked ? 'Unlike' : 'Like';

    const replyBtn = document.getElementById('statusReplyBtn');
    const replySection = document.getElementById('replySection');
    const likeDiv = document.getElementById('statusLikeBtn');
    
    if (status.senderId === myUserId) {
        replyBtn.style.display = 'none';
        likeDiv.style.display = 'none';
        deleteStatusBtn.style.display = 'inline-block';
        replySection.style.display = 'none';
    } else {
        replyBtn.style.display = 'inline-block';
        likeDiv.style.display = 'inline-block';
        deleteStatusBtn.style.display = 'none';
        replySection.style.display = 'none'; 
    }
    
    document.getElementById('statusViewer').style.display = 'flex';
}

function deleteStatus(id) {
    if (confirm("Anda yakin ingin menghapus status ini secara permanen?")) {
        let allStatuses = JSON.parse(localStorage.getItem(STATUS_KEY) || '[]');
        const updatedStatuses = allStatuses.filter(s => s.id !== id);
        
        localStorage.setItem(STATUS_KEY, JSON.stringify(updatedStatuses));
        renderStatusList();
        document.getElementById('statusViewer').style.display = 'none';
        alert("Status berhasil dihapus!");
        
        // PENTING: Beri tahu klien lain!
        emitStatusUpdate(); 
    }
}

document.getElementById('deleteStatusBtn').addEventListener('click', () => {
    if (currentStatusId) deleteStatus(currentStatusId);
});

document.getElementById('statusLikeBtn').addEventListener('click', () => {
    if (!currentStatusId) return;

    let allStatuses = JSON.parse(localStorage.getItem(STATUS_KEY) || '[]');
    const index = allStatuses.findIndex(s => s.id === currentStatusId);

    if (index !== -1) {
        let status = allStatuses[index];
        const isLiked = status.likes.includes(myUserId);

        if (isLiked) { status.likes = status.likes.filter(id => id !== myUserId); } 
        else { status.likes.push(myUserId); }

        allStatuses[index] = status;
        localStorage.setItem(STATUS_KEY, JSON.stringify(allStatuses));
        viewStatus(currentStatusId); 
        renderStatusList(); 
        
        // PENTING: Beri tahu klien lain!
        emitStatusUpdate(); 
    }
});

document.getElementById('statusReplyBtn').addEventListener('click', () => { document.getElementById('replySection').style.display = 'flex'; });

document.getElementById('sendReplyBtn').addEventListener('click', () => {
    const replyInput = document.getElementById('statusReplyInput');
    const replyText = replyInput.value.trim();
    
    if (replyText === '') return;

    let allStatuses = JSON.parse(localStorage.getItem(STATUS_KEY) || '[]');
    const statusIndex = allStatuses.findIndex(s => s.id === currentStatusId);
    
    if (statusIndex !== -1) {
        const originalStatus = allStatuses[statusIndex];
        
        const recipientId = originalStatus.senderId;
        
        const messageData = {
            senderId: myUserId,
            recipientId: recipientId, 
            message: `[REPLY STATUS dari ${myUserName} ke ${originalStatus.senderName}: "${originalStatus.message.substring(0, 15)}..."] ${replyText}`,
            media: null,
            timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
            status: 'schedule', // FIX: Status awal 'schedule'
            id: Date.now() // FIX: ID sementara
        };

        // Tampilkan pesan "schedule" sementara
        addMessageToChat(messageData);

        // Langsung kirim ke Socket.IO.
        socket.emit('send_message', messageData);

        
        alert(`Balasan Anda berhasil dikirim ke ${originalStatus.senderName} melalui Chat!`);
        
        replyInput.value = '';
        document.getElementById('statusViewer').style.display = 'none';
    }
});


// **LOGIKA ZAZA AI CHAT (Dipotong)**
const zazaAIInput = document.getElementById('zazaAIInput');
const sendZazaAIBtn = document.getElementById('sendZazaAIBtn');
const zazaAIMessages = document.getElementById('zazaAIMessages');
const ZAZA_AI_HISTORY_KEY = 'zazaAIHistory';

function addMessageToZazaAIChat(message, sender, isHistory = false) {
    const msgDiv = document.createElement('div');
    const isUser = sender === 'user';
    
    msgDiv.classList.add('ai-chat-bubble');
    msgDiv.classList.add(isUser ? 'ai-bubble-user' : 'ai-bubble-zaza');
    msgDiv.style.marginBottom = '10px';
    msgDiv.style.alignSelf = isUser ? 'flex-end' : 'flex-start';
    msgDiv.innerHTML = message;

    zazaAIMessages.appendChild(msgDiv);
    if (!isHistory) zazaAIMessages.scrollTop = zazaAIMessages.scrollHeight;
}

function saveZazaAIChatHistory(message, sender) {
    let history = JSON.parse(localStorage.getItem(getLocalStorageKey(ZAZA_AI_HISTORY_KEY)) || '[]');
    history.push({ message, sender, timestamp: new Date().toLocaleString('id-ID') });
    localStorage.setItem(getLocalStorageKey(ZAZA_AI_HISTORY_KEY), JSON.stringify(history));
}

function loadZazaAIChatHistory() {
    let history = JSON.parse(localStorage.getItem(getLocalStorageKey(ZAZA_AI_HISTORY_KEY)) || '[]');
    const initialMessage = zazaAIMessages.querySelector('.ai-bubble-zaza:first-child');
    zazaAIMessages.innerHTML = '';
    if(initialMessage) zazaAIMessages.appendChild(initialMessage);
    
    history.forEach(msg => {
        addMessageToZazaAIChat(msg.message, msg.sender, true);
    });
    zazaAIMessages.scrollTop = zazaAIMessages.scrollHeight;
}

sendZazaAIBtn.addEventListener('click', () => {
    const userMessage = zazaAIInput.value.trim();
    if (userMessage === '') return;

    addMessageToZazaAIChat(userMessage, 'user');
    saveZazaAIChatHistory(userMessage, 'user');
    zazaAIInput.value = '';
    
    addMessageToZazaAIChat("Memproses permintaan Anda...", 'zaza');

    socket.emit('send_ai_message', { prompt: userMessage });
});

zazaAIInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendZazaAIBtn.click();
});


// **LOGIKA EDIT PROFILE (Dipotong)**
const editProfileBtn = document.getElementById('editProfileBtn');
const editProfileModal = document.getElementById('editProfileModal');
const editNameInput = document.getElementById('editNameInput');
const editBioInput = document.getElementById('editBioInput');
const editRoleInput = document.getElementById('editRoleInput'); // Baru
const editAvatarInput = document.getElementById('editAvatarInput');
const saveProfileBtn = document.getElementById('saveProfileBtn');

editProfileBtn.addEventListener('click', () => {
    loadUserProfiles(); // Muat ulang profil terbaru
    const currentProfile = CHAT_USER_PROFILES[myUserId];
    if (!currentProfile) return;
    
    editNameInput.value = currentProfile.name;
    editBioInput.value = currentProfile.bio;
    editAvatarInput.value = ''; 
    
    // Logika Role: Hanya Zaza dan Khirza yang dapat mengedit Role
    if (myUserId === 'zaza' || myUserId === 'khirza') {
        editRoleInput.style.display = 'block';
        editRoleInput.value = currentProfile.role;
    } else {
        editRoleInput.style.display = 'none';
        editRoleInput.value = currentProfile.role; 
    }
    
    editProfileModal.style.display = 'flex';
});

saveProfileBtn.addEventListener('click', () => {
    const newName = editNameInput.value.trim();
    const newBio = editBioInput.value.trim();
    const newRole = editRoleInput.value.trim(); 
    const currentProfile = CHAT_USER_PROFILES[myUserId];
    
    if (newName === '' || newBio === '') {
        alert('Nama dan Bio tidak boleh kosong!');
        return;
    }
    
    // Perbarui profil
    currentProfile.name = newName;
    currentProfile.bio = newBio;
    // Perbarui Role jika diizinkan
    if (myUserId === 'zaza' || myUserId === 'khirza') {
         currentProfile.role = newRole;
    }
    
    // Logika Avatar Default
    if (!currentProfile.avatar.startsWith('data:image')) {
        if (myUserId === 'anomali1') currentProfile.avatar = '1';
        else if (myUserId === 'anomali2') currentProfile.avatar = '2';
        else if (myUserId === 'anomali3') currentProfile.avatar = '3';
        else {
             const nameParts = newName.split(' ').map(n => n[0]).join('').toUpperCase();
             currentProfile.avatar = nameParts.substring(0, 2);
        }
    }
    
    CHAT_USER_PROFILES[myUserId] = currentProfile;
    
    saveUserProfiles(); // Simpan ke global localStorage
    
    showProfilePage(); 
    myUserName = newName; 
    document.getElementById('displayUsername').textContent = myUserName.toUpperCase();
    
    editProfileModal.style.display = 'none';
    alert('Profil berhasil diperbarui dan dapat dilihat oleh pengguna lain!');
});

editAvatarInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const currentProfile = CHAT_USER_PROFILES[myUserId];
            
            currentProfile.avatar = event.target.result; 
            
            CHAT_USER_PROFILES[myUserId] = currentProfile;
            
            renderAvatar(document.getElementById('profileAvatar'), currentProfile);
            
            alert('Avatar berhasil diganti! Tekan "Simpan Perubahan" untuk menyimpan nama, bio & role.');
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('profileAvatar').addEventListener('click', () => {
    editProfileBtn.click();
});
</script>
</body>
      </html>
